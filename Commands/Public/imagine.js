/**
 * AI Image Generation Command
 * Premium feature - generates images using AI (DALL-E, Stability AI, etc.)
 */

const TierManager = require("../../Modules/TierManager");

module.exports = async ({ Constants: { Colors }, client, configJS }, { serverDocument }, msg, commandData) => {
	// Check if server has ai_images feature (premium is per-server)
	const hasImageAccess = await TierManager.canAccess(msg.guild.id, "ai_images");
	if (!hasImageAccess) {
		return msg.send({
			embeds: [{
				color: Colors.SOFT_ERR,
				title: "Premium Feature",
				description: "AI Image Generation requires a premium subscription.",
				fields: [
					{
						name: "What you get",
						value: "• Generate images from text prompts\n• Multiple AI models (DALL-E, Stable Diffusion)\n• Various sizes and styles",
					},
				],
				footer: { text: "Upgrade your membership to access this feature." },
			}],
		});
	}

	const suffix = msg.suffix ? msg.suffix.trim() : "";

	if (!suffix) {
		return msg.sendInvalidUsage(commandData, "Missing Prompt", "Please provide a description of the image you want to generate.");
	}

	// Parse arguments
	const args = suffix.split(" ");
	let size = "1024x1024";
	let style = "vivid";
	let prompt = suffix;

	// Check for size flag
	const sizeIndex = args.findIndex(a => a.startsWith("--size="));
	if (sizeIndex !== -1) {
		const sizeArg = args[sizeIndex].split("=")[1];
		if (["256x256", "512x512", "1024x1024", "1024x1792", "1792x1024"].includes(sizeArg)) {
			size = sizeArg;
		}
		args.splice(sizeIndex, 1);
		prompt = args.join(" ");
	}

	// Check for style flag
	const styleIndex = args.findIndex(a => a.startsWith("--style="));
	if (styleIndex !== -1) {
		const styleArg = args[styleIndex].split("=")[1];
		if (["vivid", "natural"].includes(styleArg)) {
			style = styleArg;
		}
		args.splice(styleIndex, 1);
		prompt = args.join(" ");
	}

	// Check if AI image generation is configured
	const aiConfig = serverDocument.config.ai || {};
	const imageConfig = aiConfig.image_generation || {};

	if (!imageConfig.enabled && !configJS.ai?.openai?.apiKey) {
		return msg.send({
			embeds: [{
				color: Colors.SOFT_ERR,
				title: "Not Configured",
				description: "AI Image Generation is not configured on this server.",
				footer: { text: "Server administrators can enable this in the dashboard." },
			}],
		});
	}

	// Send processing message
	const processingMsg = await msg.send({
		embeds: [{
			color: Colors.INFO,
			title: "Generating Image...",
			description: `Creating your image with prompt:\n\`\`\`${prompt.substring(0, 200)}${prompt.length > 200 ? "..." : ""}\`\`\``,
			footer: { text: `Size: ${size} | Style: ${style}` },
		}],
	});

	try {
		// Get AI manager
		if (!client.aiManager) {
			const { AIManager } = require("../../Modules/AI");
			client.aiManager = new AIManager(client);
			await client.aiManager.initialize();
		}

		// Generate image using provider
		const result = await client.aiManager.generateImage({
			prompt,
			size,
			style,
			userId: msg.author.id,
			guildId: msg.guild.id,
		});

		if (result.error) {
			return processingMsg.edit({
				embeds: [{
					color: Colors.SOFT_ERR,
					title: "Generation Failed",
					description: result.error,
				}],
			});
		}

		// Send result
		await processingMsg.edit({
			embeds: [{
				color: Colors.SUCCESS,
				title: "Image Generated",
				description: `**Prompt:** ${prompt.substring(0, 100)}${prompt.length > 100 ? "..." : ""}`,
				image: { url: result.url },
				footer: { text: `Generated by ${msg.author.username} | Size: ${size}` },
			}],
		});
	} catch (error) {
		logger.warn("AI image generation error", { usrid: msg.author.id, svrid: msg.guild.id }, error);

		await processingMsg.edit({
			embeds: [{
				color: Colors.ERROR,
				title: "Generation Error",
				description: "An error occurred while generating the image. Please try again later.",
				footer: { text: error.message?.substring(0, 100) || "Unknown error" },
			}],
		});
	}
};

module.exports.commandData = {
	name: "imagine",
	description: "Generate AI images from text prompts (Premium)",
	usage: "<prompt> [--size=1024x1024] [--style=vivid]",
	category: "Fun",
	isNSFWFiltered: true,
	defaults: {
		isEnabled: true,
		isNSFWFiltered: true,
		adminLevel: 0,
	},
};
