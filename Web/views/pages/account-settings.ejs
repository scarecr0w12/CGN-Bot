<!DOCTYPE html>
<html lang="en">
<head>
	<title>Account Settings</title>
	<%- include('../partials/head') %>
	<style>
		.provider-card {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 1rem;
			border: 1px solid #dbdbdb;
			border-radius: 8px;
			margin-bottom: 1rem;
		}
		.provider-card.is-linked {
			border-color: #48c774;
			background-color: #f6fff8;
		}
		.provider-info {
			display: flex;
			align-items: center;
			gap: 1rem;
		}
		.provider-icon {
			width: 40px;
			height: 40px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.5rem;
		}
		.server-card {
			display: flex;
			align-items: center;
			padding: 0.75rem;
			border: 1px solid #dbdbdb;
			border-radius: 8px;
			margin-bottom: 0.5rem;
			transition: all 0.2s ease;
			cursor: pointer;
		}
		.server-card:hover {
			border-color: #3273dc;
			background-color: #f5f8ff;
		}
		.server-card.has-profile {
			border-left: 3px solid #48c774;
		}
		.server-icon {
			width: 48px;
			height: 48px;
			border-radius: 50%;
			margin-right: 1rem;
			object-fit: cover;
		}
		.server-info {
			flex: 1;
		}
		.server-info h4 {
			margin: 0 0 0.25rem 0;
			font-weight: 600;
		}
		.server-info p {
			margin: 0;
			font-size: 0.85rem;
			color: #666;
		}
		.profile-field-row {
			display: flex;
			gap: 0.5rem;
			margin-bottom: 0.5rem;
			align-items: center;
		}
		.profile-field-row input {
			flex: 1;
		}
		.profile-field-row .field-name {
			width: 30%;
			min-width: 100px;
		}
		.profile-field-row .field-value {
			flex: 1;
		}
		.servers-loading {
			text-align: center;
			padding: 2rem;
			color: #666;
		}
		/* Vote Rewards Styles */
		.vote-balance-card {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 1.5rem;
			border-radius: 12px;
			margin-bottom: 1.5rem;
		}
		.vote-balance-card .balance-amount {
			font-size: 2.5rem;
			font-weight: bold;
		}
		.vote-balance-card .balance-label {
			opacity: 0.9;
			font-size: 0.9rem;
		}
		.vote-site-card {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 1rem;
			border: 1px solid #dbdbdb;
			border-radius: 8px;
			margin-bottom: 0.75rem;
			transition: all 0.2s ease;
		}
		.vote-site-card:hover {
			border-color: #667eea;
			box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
		}
		.vote-site-card.can-vote {
			border-color: #48c774;
			background-color: #f6fff8;
		}
		.vote-site-info {
			display: flex;
			align-items: center;
			gap: 1rem;
		}
		.vote-site-icon {
			width: 40px;
			height: 40px;
			border-radius: 8px;
			object-fit: cover;
		}
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 1rem;
			margin-top: 1rem;
		}
		.stat-item {
			text-align: center;
			padding: 0.75rem;
			background: rgba(255,255,255,0.1);
			border-radius: 8px;
		}
		.stat-value {
			font-size: 1.25rem;
			font-weight: bold;
		}
		.stat-label {
			font-size: 0.75rem;
			opacity: 0.8;
		}
		.tier-card {
			border: 1px solid #dbdbdb;
			border-radius: 8px;
			padding: 1rem;
			margin-bottom: 0.75rem;
		}
		.tier-card:hover {
			border-color: #667eea;
		}
		.transaction-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0.75rem;
			border-bottom: 1px solid #f0f0f0;
		}
		.transaction-item:last-child {
			border-bottom: none;
		}
		.transaction-amount.positive {
			color: #48c774;
		}
		.transaction-amount.negative {
			color: #f14668;
		}
	</style>
</head>
<body>
	<%- include('../partials/header') %>

	<section class="section">
		<div class="container">
			<h1 class="title">
				<span class="icon"><i class="fa fa-user-cog"></i></span>
				Account Settings
			</h1>

			<% if (success) { %>
			<article class="message is-success">
				<div class="message-body">
					Account linked successfully!
				</div>
			</article>
			<% } %>

			<% if (error) { %>
			<article class="message is-danger">
				<div class="message-body">
					Failed to link account. Please try again.
				</div>
			</article>
			<% } %>

			<div class="columns">
			<!-- Vote Rewards Section -->
			<div class="column is-half">
				<div class="box" id="vote-rewards-section">
					<h2 class="subtitle">
						<span class="icon"><i class="fa fa-vote-yea"></i></span>
						Vote Rewards
					</h2>
					<div id="vote-rewards-content">
						<div class="servers-loading">
							<span class="icon"><i class="fa fa-spinner fa-spin"></i></span>
							<span>Loading vote rewards...</span>
						</div>
					</div>
				</div>
			</div>

			<!-- Linked Accounts -->
			<div class="column is-half">
					<div class="box">
						<h2 class="subtitle">
							<span class="icon"><i class="fa fa-link"></i></span>
							Linked Accounts
						</h2>
						<p class="mb-4 has-text-grey">Link additional accounts for extra features and integrations.</p>

						<!-- Discord (Primary - Always Linked) -->
						<div class="provider-card is-linked">
							<div class="provider-info">
								<div class="provider-icon has-text-link">
									<i class="fab fa-discord"></i>
								</div>
								<div>
									<p class="has-text-weight-bold">Discord</p>
									<p class="is-size-7 has-text-grey"><%= authUser.username %> (Primary)</p>
								</div>
							</div>
							<span class="tag is-success">Connected</span>
						</div>

						<% const getLinkedAccount = (provider) => linkedAccounts.find(a => a._id === provider); %>

						<!-- Google -->
						<% if (oauthProviders.google?.isEnabled) { %>
						<% const googleAccount = getLinkedAccount('google'); %>
						<div class="provider-card <%= googleAccount ? 'is-linked' : '' %>">
							<div class="provider-info">
								<div class="provider-icon has-text-danger">
									<i class="fab fa-google"></i>
								</div>
								<div>
									<p class="has-text-weight-bold">Google</p>
									<% if (googleAccount) { %>
									<p class="is-size-7 has-text-grey"><%= googleAccount.email || googleAccount.username %></p>
									<% } else { %>
									<p class="is-size-7 has-text-grey">Not connected</p>
									<% } %>
								</div>
							</div>
							<% if (googleAccount) { %>
							<button class="button is-small is-danger is-outlined" onclick="unlinkAccount('google')">Unlink</button>
							<% } else { %>
							<a class="button is-small is-info" href="/auth/google">Link</a>
							<% } %>
						</div>
						<% } %>

						<!-- GitHub -->
						<% if (oauthProviders.github?.isEnabled) { %>
						<% const githubAccount = getLinkedAccount('github'); %>
						<div class="provider-card <%= githubAccount ? 'is-linked' : '' %>">
							<div class="provider-info">
								<div class="provider-icon">
									<i class="fab fa-github"></i>
								</div>
								<div>
									<p class="has-text-weight-bold">GitHub</p>
									<% if (githubAccount) { %>
									<p class="is-size-7 has-text-grey"><%= githubAccount.username %></p>
									<% } else { %>
									<p class="is-size-7 has-text-grey">Not connected</p>
									<% } %>
								</div>
							</div>
							<% if (githubAccount) { %>
							<button class="button is-small is-danger is-outlined" onclick="unlinkAccount('github')">Unlink</button>
							<% } else { %>
							<a class="button is-small is-info" href="/auth/github">Link</a>
							<% } %>
						</div>
						<% } %>

						<!-- Twitch -->
						<% if (oauthProviders.twitch?.isEnabled) { %>
						<% const twitchAccount = getLinkedAccount('twitch'); %>
						<div class="provider-card <%= twitchAccount ? 'is-linked' : '' %>">
							<div class="provider-info">
								<div class="provider-icon has-text-purple">
									<i class="fab fa-twitch"></i>
								</div>
								<div>
									<p class="has-text-weight-bold">Twitch</p>
									<% if (twitchAccount) { %>
									<p class="is-size-7 has-text-grey"><%= twitchAccount.username %></p>
									<% } else { %>
									<p class="is-size-7 has-text-grey">Not connected</p>
									<% } %>
								</div>
							</div>
							<% if (twitchAccount) { %>
							<button class="button is-small is-danger is-outlined" onclick="unlinkAccount('twitch')">Unlink</button>
							<% } else { %>
							<a class="button is-small is-info" href="/auth/twitch">Link</a>
							<% } %>
						</div>
						<% } %>

						<!-- Patreon -->
						<% if (oauthProviders.patreon?.isEnabled) { %>
						<% const patreonAccount = getLinkedAccount('patreon'); %>
						<div class="provider-card <%= patreonAccount ? 'is-linked' : '' %>">
							<div class="provider-info">
								<div class="provider-icon" style="color: #FF424D;">
									<i class="fab fa-patreon"></i>
								</div>
								<div>
									<p class="has-text-weight-bold">Patreon</p>
									<% if (patreonAccount) { %>
									<p class="is-size-7 has-text-grey"><%= patreonAccount.username %></p>
									<% } else { %>
									<p class="is-size-7 has-text-grey">Not connected - Link to sync pledges</p>
									<% } %>
								</div>
							</div>
							<% if (patreonAccount) { %>
							<button class="button is-small is-danger is-outlined" onclick="unlinkAccount('patreon')">Unlink</button>
							<% } else { %>
							<a class="button is-small is-info" href="/auth/patreon">Link</a>
							<% } %>
						</div>
						<% } %>

						<% if (!oauthProviders.google?.isEnabled && !oauthProviders.github?.isEnabled && !oauthProviders.twitch?.isEnabled && !oauthProviders.patreon?.isEnabled) { %>
						<p class="has-text-grey">No additional OAuth providers are enabled.</p>
						<% } %>
					</div>
				</div>
			</div>

			<!-- Server Profiles Section -->
			<div class="box mt-5">
				<h2 class="subtitle">
					<span class="icon"><i class="fa fa-server"></i></span>
					Server Profiles
				</h2>
				<p class="mb-4 has-text-grey">Create and manage custom profiles for each server you're in. These profiles are visible to other members on that server.</p>

				<div id="servers-list">
					<div class="servers-loading">
						<span class="icon"><i class="fa fa-spinner fa-spin"></i></span>
						<span>Loading your servers...</span>
					</div>
				</div>
			</div>
		</div>
	</section>

	<!-- Server Profile Edit Modal -->
	<div id="profile-modal" class="modal">
		<div class="modal-background" onclick="closeProfileModal()"></div>
		<div class="modal-card">
			<header class="modal-card-head">
				<p class="modal-card-title">
					<span class="icon"><i class="fa fa-user-edit"></i></span>
					<span id="modal-server-name">Edit Profile</span>
				</p>
				<button class="delete" aria-label="close" onclick="closeProfileModal()"></button>
			</header>
			<section class="modal-card-body">
				<input type="hidden" id="modal-server-id">
				
				<div class="notification is-info is-light">
					<span class="icon"><i class="fa fa-info-circle"></i></span>
					Add custom fields to your profile for this server. Other members can view these fields.
				</div>

				<div id="profile-fields-container">
					<!-- Fields will be dynamically added here -->
				</div>

				<button type="button" class="button is-small is-info is-outlined mt-3" onclick="addProfileField()">
					<span class="icon"><i class="fa fa-plus"></i></span>
					<span>Add Field</span>
				</button>

				<p class="help mt-3">Maximum 10 fields. Field names: 100 chars max. Values: 500 chars max.</p>
			</section>
			<footer class="modal-card-foot">
				<button class="button is-success" onclick="saveProfile()" id="save-profile-btn">
					<span class="icon"><i class="fa fa-save"></i></span>
					<span>Save Profile</span>
				</button>
				<button class="button is-danger is-outlined" onclick="deleteProfile()" id="delete-profile-btn">
					<span class="icon"><i class="fa fa-trash"></i></span>
					<span>Delete Profile</span>
				</button>
				<button class="button" onclick="closeProfileModal()">Cancel</button>
			</footer>
		</div>
	</div>

	<!-- Redeem Points Modal -->
	<div id="redeem-modal" class="modal">
		<div class="modal-background" onclick="closeRedeemModal()"></div>
		<div class="modal-card">
			<header class="modal-card-head">
				<p class="modal-card-title">
					<span class="icon"><i class="fa fa-gift"></i></span>
					<span>Redeem Vote Rewards</span>
				</p>
				<button class="delete" aria-label="close" onclick="closeRedeemModal()"></button>
			</header>
			<section class="modal-card-body">
				<div class="notification is-info is-light mb-4">
					<span class="icon"><i class="fa fa-info-circle"></i></span>
					<span>Use your vote reward points to purchase premium tier access for your servers.</span>
				</div>
				
				<div id="redeem-servers-list"></div>
				<div id="redeem-tiers-list"></div>
			</section>
			<footer class="modal-card-foot">
				<button class="button is-success" onclick="confirmRedeem()" id="confirm-redeem-btn">
					<span class="icon"><i class="fa fa-check"></i></span>
					<span>Confirm Redemption</span>
				</button>
				<button class="button" onclick="closeRedeemModal()">Cancel</button>
			</footer>
		</div>
	</div>

	<!-- Transaction History Modal -->
	<div id="history-modal" class="modal">
		<div class="modal-background" onclick="closeHistoryModal()"></div>
		<div class="modal-card">
			<header class="modal-card-head">
				<p class="modal-card-title">
					<span class="icon"><i class="fa fa-history"></i></span>
					<span>Transaction History</span>
				</p>
				<button class="delete" aria-label="close" onclick="closeHistoryModal()"></button>
			</header>
			<section class="modal-card-body">
				<div id="history-modal-content"></div>
			</section>
			<footer class="modal-card-foot">
				<button class="button" onclick="closeHistoryModal()">Close</button>
			</footer>
		</div>
	</div>

	<%- include('../partials/footer') %>

	<script>
	// Unlink OAuth account
	async function unlinkAccount(provider) {
		if (!confirm(`Are you sure you want to unlink your ${provider} account?`)) {
			return;
		}

		try {
			const response = await fetch(`/account/unlink/${provider}`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
			});

			if (response.ok) {
				location.reload();
			} else {
				alert('Failed to unlink account. Please try again.');
			}
		} catch (err) {
			alert('An error occurred. Please try again.');
		}
	}

	// Server profiles functionality
	let serversData = [];

	// Load servers on page load
	document.addEventListener('DOMContentLoaded', loadServers);

	async function loadServers() {
		const container = document.getElementById('servers-list');
		
		try {
			const response = await fetch('/account/servers');
			if (!response.ok) throw new Error('Failed to fetch servers');
			
			const data = await response.json();
			serversData = data.servers || [];
			
			if (serversData.length === 0) {
				container.innerHTML = `
					<div class="notification is-warning is-light">
						<span class="icon"><i class="fa fa-exclamation-triangle"></i></span>
						<span>You're not in any servers where the bot is present.</span>
					</div>
				`;
				return;
			}
			
			renderServersList();
		} catch (err) {
			console.error('Error loading servers:', err);
			container.innerHTML = `
				<div class="notification is-danger is-light">
					<span class="icon"><i class="fa fa-exclamation-circle"></i></span>
					<span>Failed to load servers. Please refresh the page.</span>
				</div>
			`;
		}
	}

	function renderServersList() {
		const container = document.getElementById('servers-list');
		
		const html = serversData.map(server => `
			<div class="server-card ${server.hasProfile ? 'has-profile' : ''}" onclick="openProfileModal('${server.id}')">
				<img src="${server.icon}" alt="${escapeHtml(server.name)}" class="server-icon" onerror="this.src='/static/img/discord-icon.png'">
				<div class="server-info">
					<h4>${escapeHtml(server.name)}</h4>
					<p>
						<span class="icon is-small"><i class="fa fa-users"></i></span>
						${server.memberCount} members
						<span class="ml-3 icon is-small"><i class="fa fa-crown"></i></span>
						${escapeHtml(server.owner)}
					</p>
				</div>
				<div>
					${server.hasProfile 
						? '<span class="tag is-success"><span class="icon is-small"><i class="fa fa-check"></i></span><span>Profile Set</span></span>' 
						: '<span class="tag is-light"><span class="icon is-small"><i class="fa fa-plus"></i></span><span>Add Profile</span></span>'
					}
				</div>
			</div>
		`).join('');
		
		container.innerHTML = html;
	}

	function openProfileModal(serverId) {
		const server = serversData.find(s => s.id === serverId);
		if (!server) return;
		
		document.getElementById('modal-server-id').value = serverId;
		document.getElementById('modal-server-name').textContent = `Edit Profile - ${server.name}`;
		
		const container = document.getElementById('profile-fields-container');
		container.innerHTML = '';
		
		// Load existing profile fields
		const profile = server.profile || {};
		const keys = Object.keys(profile);
		
		if (keys.length > 0) {
			keys.forEach(key => {
				addProfileField(key, profile[key]);
			});
		} else {
			// Add one empty field to start
			addProfileField();
		}
		
		document.getElementById('profile-modal').classList.add('is-active');
	}

	function closeProfileModal() {
		document.getElementById('profile-modal').classList.remove('is-active');
	}

	function addProfileField(name = '', value = '') {
		const container = document.getElementById('profile-fields-container');
		const fieldCount = container.querySelectorAll('.profile-field-row').length;
		
		if (fieldCount >= 10) {
			alert('Maximum 10 fields allowed');
			return;
		}
		
		const row = document.createElement('div');
		row.className = 'profile-field-row';
		row.innerHTML = `
			<input type="text" class="input field-name" placeholder="Field Name (e.g., Bio, Location)" maxlength="100" value="${escapeHtml(name)}">
			<input type="text" class="input field-value" placeholder="Value" maxlength="500" value="${escapeHtml(value)}">
			<button type="button" class="button is-small is-danger is-outlined" onclick="this.parentElement.remove()">
				<span class="icon"><i class="fa fa-times"></i></span>
			</button>
		`;
		
		container.appendChild(row);
	}

	async function saveProfile() {
		const serverId = document.getElementById('modal-server-id').value;
		const container = document.getElementById('profile-fields-container');
		const rows = container.querySelectorAll('.profile-field-row');
		
		const profile_fields = {};
		
		rows.forEach(row => {
			const name = row.querySelector('.field-name').value.trim();
			const value = row.querySelector('.field-value').value.trim();
			
			if (name && value) {
				profile_fields[name] = value;
			}
		});
		
		const btn = document.getElementById('save-profile-btn');
		btn.classList.add('is-loading');
		btn.disabled = true;
		
		try {
			const response = await fetch(`/account/servers/${serverId}/profile`, {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ profile_fields })
			});
			
			const data = await response.json();
			
			if (!response.ok) {
				throw new Error(data.error || 'Failed to save profile');
			}
			
			// Update local data
			const serverIndex = serversData.findIndex(s => s.id === serverId);
			if (serverIndex !== -1) {
				serversData[serverIndex].profile = profile_fields;
				serversData[serverIndex].hasProfile = Object.keys(profile_fields).length > 0;
			}
			
			renderServersList();
			closeProfileModal();
			
			// Show success notification
			showNotification('Profile saved successfully!', 'success');
		} catch (err) {
			alert(err.message || 'Failed to save profile');
		} finally {
			btn.classList.remove('is-loading');
			btn.disabled = false;
		}
	}

	async function deleteProfile() {
		if (!confirm('Are you sure you want to delete your profile for this server?')) {
			return;
		}
		
		const serverId = document.getElementById('modal-server-id').value;
		const btn = document.getElementById('delete-profile-btn');
		btn.classList.add('is-loading');
		btn.disabled = true;
		
		try {
			const response = await fetch(`/account/servers/${serverId}/profile`, {
				method: 'DELETE'
			});
			
			if (!response.ok) {
				const data = await response.json();
				throw new Error(data.error || 'Failed to delete profile');
			}
			
			// Update local data
			const serverIndex = serversData.findIndex(s => s.id === serverId);
			if (serverIndex !== -1) {
				serversData[serverIndex].profile = {};
				serversData[serverIndex].hasProfile = false;
			}
			
			renderServersList();
			closeProfileModal();
			
			showNotification('Profile deleted successfully!', 'info');
		} catch (err) {
			alert(err.message || 'Failed to delete profile');
		} finally {
			btn.classList.remove('is-loading');
			btn.disabled = false;
		}
	}

	function escapeHtml(text) {
		const div = document.createElement('div');
		div.textContent = text;
		return div.innerHTML;
	}

	function showNotification(message, type = 'info') {
		const notification = document.createElement('div');
		notification.className = `notification is-${type} is-light`;
		notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
		notification.innerHTML = `
			<button class="delete" onclick="this.parentElement.remove()"></button>
			${escapeHtml(message)}
		`;
		document.body.appendChild(notification);
		
		setTimeout(() => {
			notification.remove();
		}, 3000);
	}

	// Close modal on escape key
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			closeProfileModal();
			closeRedeemModal();
		}
	});

	// ============================================
	// VOTE REWARDS FUNCTIONALITY
	// ============================================

	let voteRewardsData = null;

	// Load vote rewards on page load
	document.addEventListener('DOMContentLoaded', loadVoteRewards);

	async function loadVoteRewards() {
		const container = document.getElementById('vote-rewards-content');
		
		try {
			const response = await fetch('/account/vote-rewards');
			if (!response.ok) throw new Error('Failed to fetch vote rewards');
			
			voteRewardsData = await response.json();
			
			if (!voteRewardsData.isEnabled) {
				container.innerHTML = `
					<div class="notification is-info is-light">
						<span class="icon"><i class="fa fa-info-circle"></i></span>
						<span>Vote rewards are not currently enabled.</span>
					</div>
				`;
				return;
			}
			
			renderVoteRewards();
		} catch (err) {
			console.error('Error loading vote rewards:', err);
			container.innerHTML = `
				<div class="notification is-danger is-light">
					<span class="icon"><i class="fa fa-exclamation-circle"></i></span>
					<span>Failed to load vote rewards. Please refresh the page.</span>
				</div>
			`;
		}
	}

	function renderVoteRewards() {
		const container = document.getElementById('vote-rewards-content');
		const data = voteRewardsData;
		
		const voteSitesHtml = data.voteSites.length > 0 ? data.voteSites.map(site => {
			const canVoteNow = site.canVote;
			const cooldownText = canVoteNow ? 'Ready to vote!' : formatTimeRemaining(site.timeRemaining);
			
			return `
				<div class="vote-site-card ${canVoteNow ? 'can-vote' : ''}">
					<div class="vote-site-info">
						<img src="${site.icon}" alt="${escapeHtml(site.name)}" class="vote-site-icon" onerror="this.src='/static/img/discord-icon.png'">
						<div>
							<p class="has-text-weight-bold">${escapeHtml(site.name)}</p>
							<p class="is-size-7 has-text-grey">
								${canVoteNow ? `<span class="has-text-success">+${data.pointsPerVote} points</span>` : cooldownText}
							</p>
						</div>
					</div>
					<a href="${site.url}" target="_blank" class="button is-small ${canVoteNow ? 'is-success' : 'is-light'}" ${!canVoteNow ? 'disabled' : ''}>
						<span class="icon"><i class="fa fa-external-link-alt"></i></span>
						<span>${canVoteNow ? 'Vote Now' : 'Cooldown'}</span>
					</a>
				</div>
			`;
		}).join('') : '<p class="has-text-grey">No vote sites configured.</p>';
		
		container.innerHTML = `
			<div class="vote-balance-card">
				<div class="balance-label">Your Vote Rewards Balance</div>
				<div class="balance-amount">${data.balance.toLocaleString()} <small>points</small></div>
				<div class="stats-grid">
					<div class="stat-item">
						<div class="stat-value">${data.totalVotes}</div>
						<div class="stat-label">Total Votes</div>
					</div>
					<div class="stat-item">
						<div class="stat-value">${data.lifetimeEarned.toLocaleString()}</div>
						<div class="stat-label">Earned</div>
					</div>
					<div class="stat-item">
						<div class="stat-value">${data.lifetimeSpent.toLocaleString()}</div>
						<div class="stat-label">Spent</div>
					</div>
				</div>
			</div>
			
			<h4 class="title is-6 mb-3">
				<span class="icon"><i class="fa fa-star"></i></span>
				Vote to Earn Points
			</h4>
			<p class="is-size-7 has-text-grey mb-3">
				Vote on these sites to earn ${data.pointsPerVote} points (${data.weekendMultiplier}x on weekends!)
			</p>
			${voteSitesHtml}
			
			<hr>
			
			<div class="buttons">
				<button class="button is-primary" onclick="openRedeemModal()">
					<span class="icon"><i class="fa fa-gift"></i></span>
					<span>Redeem Points</span>
				</button>
				<button class="button is-info is-outlined" onclick="viewTransactionHistory()">
					<span class="icon"><i class="fa fa-history"></i></span>
					<span>History</span>
				</button>
			</div>
		`;
	}

	function formatTimeRemaining(ms) {
		if (!ms) return 'Unknown';
		const hours = Math.floor(ms / (1000 * 60 * 60));
		const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
		if (hours > 0) {
			return `${hours}h ${minutes}m remaining`;
		}
		return `${minutes}m remaining`;
	}

	// Redeem Modal
	let ownedServers = [];
	let availableTiers = [];

	async function openRedeemModal() {
		document.getElementById('redeem-modal').classList.add('is-active');
		
		const serversContainer = document.getElementById('redeem-servers-list');
		const tiersContainer = document.getElementById('redeem-tiers-list');
		
		serversContainer.innerHTML = '<div class="servers-loading"><span class="icon"><i class="fa fa-spinner fa-spin"></i></span> Loading servers...</div>';
		tiersContainer.innerHTML = '';
		
		try {
			const [serversRes, tiersRes] = await Promise.all([
				fetch('/account/vote-rewards/owned-servers'),
				fetch('/account/vote-rewards/tiers')
			]);
			
			const serversData = await serversRes.json();
			const tiersData = await tiersRes.json();
			
			ownedServers = serversData.servers || [];
			availableTiers = tiersData.tiers || [];
			
			if (ownedServers.length === 0) {
				serversContainer.innerHTML = `
					<div class="notification is-warning is-light">
						<span class="icon"><i class="fa fa-exclamation-triangle"></i></span>
						<span>You don't own any servers where the bot is present.</span>
					</div>
				`;
				return;
			}
			
			renderRedeemServers();
			renderRedeemTiers(tiersData.minDays, tiersData.maxDays);
		} catch (err) {
			console.error('Error loading redeem data:', err);
			serversContainer.innerHTML = `
				<div class="notification is-danger is-light">Failed to load data.</div>
			`;
		}
	}

	function renderRedeemServers() {
		const container = document.getElementById('redeem-servers-list');
		
		container.innerHTML = `
			<label class="label">Select Server</label>
			<div class="select is-fullwidth">
				<select id="redeem-server-select" onchange="updateRedeemPreview()">
					<option value="">-- Select a server --</option>
					${ownedServers.map(s => `
						<option value="${s.id}">${escapeHtml(s.name)} (${s.memberCount} members) - Current: ${s.currentTier?.name || 'Free'}</option>
					`).join('')}
				</select>
			</div>
		`;
	}

	function renderRedeemTiers(minDays, maxDays) {
		const container = document.getElementById('redeem-tiers-list');
		
		if (availableTiers.length === 0) {
			container.innerHTML = `
				<div class="notification is-info is-light">No tiers available for redemption.</div>
			`;
			return;
		}
		
		container.innerHTML = `
			<label class="label mt-4">Select Tier</label>
			<div class="select is-fullwidth">
				<select id="redeem-tier-select" onchange="updateRedeemPreview()">
					<option value="">-- Select a tier --</option>
					${availableTiers.map(t => `
						<option value="${t.id}" data-cost-per-day="${t.pointsCostPerDay}">${escapeHtml(t.name)} - ${t.pointsCostPerDay} pts/day</option>
					`).join('')}
				</select>
			</div>
			
			<label class="label mt-4">Duration (days)</label>
			<input type="number" class="input" id="redeem-duration" min="${minDays}" max="${maxDays}" value="${minDays}" onchange="updateRedeemPreview()">
			<p class="help">Minimum: ${minDays} days, Maximum: ${maxDays} days</p>
			
			<div id="redeem-preview" class="mt-4"></div>
		`;
	}

	function updateRedeemPreview() {
		const preview = document.getElementById('redeem-preview');
		const tierSelect = document.getElementById('redeem-tier-select');
		const durationInput = document.getElementById('redeem-duration');
		const serverSelect = document.getElementById('redeem-server-select');
		
		if (!tierSelect.value || !durationInput.value || !serverSelect.value) {
			preview.innerHTML = '';
			return;
		}
		
		const costPerDay = parseInt(tierSelect.options[tierSelect.selectedIndex].dataset.costPerDay);
		const duration = parseInt(durationInput.value);
		const totalCost = costPerDay * duration;
		const balance = voteRewardsData?.balance || 0;
		const canAfford = balance >= totalCost;
		
		preview.innerHTML = `
			<div class="notification ${canAfford ? 'is-success' : 'is-danger'} is-light">
				<p><strong>Total Cost:</strong> ${totalCost.toLocaleString()} points</p>
				<p><strong>Your Balance:</strong> ${balance.toLocaleString()} points</p>
				${canAfford ? '' : '<p class="has-text-danger">Insufficient balance!</p>'}
			</div>
		`;
	}

	function closeRedeemModal() {
		document.getElementById('redeem-modal').classList.remove('is-active');
	}

	async function confirmRedeem() {
		const serverSelect = document.getElementById('redeem-server-select');
		const tierSelect = document.getElementById('redeem-tier-select');
		const durationInput = document.getElementById('redeem-duration');
		
		if (!serverSelect.value || !tierSelect.value || !durationInput.value) {
			alert('Please select a server, tier, and duration.');
			return;
		}
		
		const costPerDay = parseInt(tierSelect.options[tierSelect.selectedIndex].dataset.costPerDay);
		const duration = parseInt(durationInput.value);
		const totalCost = costPerDay * duration;
		
		if (!confirm(`Are you sure you want to spend ${totalCost.toLocaleString()} points for ${duration} days of premium?`)) {
			return;
		}
		
		const btn = document.getElementById('confirm-redeem-btn');
		btn.classList.add('is-loading');
		btn.disabled = true;
		
		try {
			const response = await fetch('/account/vote-rewards/redeem-tier', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					serverId: serverSelect.value,
					tierId: tierSelect.value,
					durationDays: duration
				})
			});
			
			const data = await response.json();
			
			if (!response.ok) {
				throw new Error(data.error || 'Failed to redeem points');
			}
			
			showNotification(`Successfully redeemed ${totalCost.toLocaleString()} points for premium!`, 'success');
			closeRedeemModal();
			loadVoteRewards(); // Refresh balance
		} catch (err) {
			alert(err.message || 'Failed to redeem points');
		} finally {
			btn.classList.remove('is-loading');
			btn.disabled = false;
		}
	}

	async function viewTransactionHistory() {
		try {
			const response = await fetch('/account/vote-rewards/history?limit=20');
			const data = await response.json();
			
			const transactions = data.transactions || [];
			
			if (transactions.length === 0) {
				alert('No transaction history yet.');
				return;
			}
			
			const historyHtml = transactions.map(t => {
				const isPositive = t.amount > 0;
				const typeLabels = {
					vote: 'Vote Reward',
					purchase: 'Points Purchase',
					redeem_tier: 'Tier Redemption',
					redeem_extension: 'Extension Purchase',
					admin_grant: 'Admin Grant',
					admin_revoke: 'Admin Revoke',
					refund: 'Refund'
				};
				return `
					<div class="transaction-item">
						<div>
							<p class="has-text-weight-semibold">${typeLabels[t.type] || t.type}</p>
							<p class="is-size-7 has-text-grey">${new Date(t.timestamp).toLocaleString()}</p>
						</div>
						<div class="transaction-amount ${isPositive ? 'positive' : 'negative'}">
							${isPositive ? '+' : ''}${t.amount.toLocaleString()}
						</div>
					</div>
				`;
			}).join('');
			
			// Show in modal
			document.getElementById('history-modal-content').innerHTML = historyHtml;
			document.getElementById('history-modal').classList.add('is-active');
		} catch (err) {
			console.error('Error loading history:', err);
			alert('Failed to load transaction history.');
		}
	}

	function closeHistoryModal() {
		document.getElementById('history-modal').classList.remove('is-active');
	}
	</script>
</body>
</html>
