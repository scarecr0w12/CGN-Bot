<!DOCTYPE html>
<html lang="en">
<head>
	<title>Account Settings</title>
	<%- include('../partials/head') %>
	<style>
		.provider-card {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 1rem;
			border: 1px solid #dbdbdb;
			border-radius: 8px;
			margin-bottom: 1rem;
		}
		.provider-card.is-linked {
			border-color: #48c774;
			background-color: #f6fff8;
		}
		.provider-info {
			display: flex;
			align-items: center;
			gap: 1rem;
		}
		.provider-icon {
			width: 40px;
			height: 40px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.5rem;
		}
		.server-card {
			display: flex;
			align-items: center;
			padding: 0.75rem;
			border: 1px solid #dbdbdb;
			border-radius: 8px;
			margin-bottom: 0.5rem;
			transition: all 0.2s ease;
			cursor: pointer;
		}
		.server-card:hover {
			border-color: #3273dc;
			background-color: #f5f8ff;
		}
		.server-card.has-profile {
			border-left: 3px solid #48c774;
		}
		.server-icon {
			width: 48px;
			height: 48px;
			border-radius: 50%;
			margin-right: 1rem;
			object-fit: cover;
		}
		.server-info {
			flex: 1;
		}
		.server-info h4 {
			margin: 0 0 0.25rem 0;
			font-weight: 600;
		}
		.server-info p {
			margin: 0;
			font-size: 0.85rem;
			color: #666;
		}
		.profile-field-row {
			display: flex;
			gap: 0.5rem;
			margin-bottom: 0.5rem;
			align-items: center;
		}
		.profile-field-row input {
			flex: 1;
		}
		.profile-field-row .field-name {
			width: 30%;
			min-width: 100px;
		}
		.profile-field-row .field-value {
			flex: 1;
		}
		.servers-loading {
			text-align: center;
			padding: 2rem;
			color: #666;
		}
	</style>
</head>
<body>
	<%- include('../partials/header') %>

	<section class="section">
		<div class="container">
			<h1 class="title">
				<span class="icon"><i class="fa fa-user-cog"></i></span>
				Account Settings
			</h1>

			<% if (success) { %>
			<article class="message is-success">
				<div class="message-body">
					Account linked successfully!
				</div>
			</article>
			<% } %>

			<% if (error) { %>
			<article class="message is-danger">
				<div class="message-body">
					Failed to link account. Please try again.
				</div>
			</article>
			<% } %>

			<div class="columns">
			<!-- Linked Accounts -->
			<div class="column is-half">
					<div class="box">
						<h2 class="subtitle">
							<span class="icon"><i class="fa fa-link"></i></span>
							Linked Accounts
						</h2>
						<p class="mb-4 has-text-grey">Link additional accounts for extra features and integrations.</p>

						<!-- Discord (Primary - Always Linked) -->
						<div class="provider-card is-linked">
							<div class="provider-info">
								<div class="provider-icon has-text-link">
									<i class="fab fa-discord"></i>
								</div>
								<div>
									<p class="has-text-weight-bold">Discord</p>
									<p class="is-size-7 has-text-grey"><%= authUser.username %> (Primary)</p>
								</div>
							</div>
							<span class="tag is-success">Connected</span>
						</div>

						<% const getLinkedAccount = (provider) => linkedAccounts.find(a => a._id === provider); %>

						<!-- Google -->
						<% if (oauthProviders.google?.isEnabled) { %>
						<% const googleAccount = getLinkedAccount('google'); %>
						<div class="provider-card <%= googleAccount ? 'is-linked' : '' %>">
							<div class="provider-info">
								<div class="provider-icon has-text-danger">
									<i class="fab fa-google"></i>
								</div>
								<div>
									<p class="has-text-weight-bold">Google</p>
									<% if (googleAccount) { %>
									<p class="is-size-7 has-text-grey"><%= googleAccount.email || googleAccount.username %></p>
									<% } else { %>
									<p class="is-size-7 has-text-grey">Not connected</p>
									<% } %>
								</div>
							</div>
							<% if (googleAccount) { %>
							<button class="button is-small is-danger is-outlined" onclick="unlinkAccount('google')">Unlink</button>
							<% } else { %>
							<a class="button is-small is-info" href="/auth/google">Link</a>
							<% } %>
						</div>
						<% } %>

						<!-- GitHub -->
						<% if (oauthProviders.github?.isEnabled) { %>
						<% const githubAccount = getLinkedAccount('github'); %>
						<div class="provider-card <%= githubAccount ? 'is-linked' : '' %>">
							<div class="provider-info">
								<div class="provider-icon">
									<i class="fab fa-github"></i>
								</div>
								<div>
									<p class="has-text-weight-bold">GitHub</p>
									<% if (githubAccount) { %>
									<p class="is-size-7 has-text-grey"><%= githubAccount.username %></p>
									<% } else { %>
									<p class="is-size-7 has-text-grey">Not connected</p>
									<% } %>
								</div>
							</div>
							<% if (githubAccount) { %>
							<button class="button is-small is-danger is-outlined" onclick="unlinkAccount('github')">Unlink</button>
							<% } else { %>
							<a class="button is-small is-info" href="/auth/github">Link</a>
							<% } %>
						</div>
						<% } %>

						<!-- Twitch -->
						<% if (oauthProviders.twitch?.isEnabled) { %>
						<% const twitchAccount = getLinkedAccount('twitch'); %>
						<div class="provider-card <%= twitchAccount ? 'is-linked' : '' %>">
							<div class="provider-info">
								<div class="provider-icon has-text-purple">
									<i class="fab fa-twitch"></i>
								</div>
								<div>
									<p class="has-text-weight-bold">Twitch</p>
									<% if (twitchAccount) { %>
									<p class="is-size-7 has-text-grey"><%= twitchAccount.username %></p>
									<% } else { %>
									<p class="is-size-7 has-text-grey">Not connected</p>
									<% } %>
								</div>
							</div>
							<% if (twitchAccount) { %>
							<button class="button is-small is-danger is-outlined" onclick="unlinkAccount('twitch')">Unlink</button>
							<% } else { %>
							<a class="button is-small is-info" href="/auth/twitch">Link</a>
							<% } %>
						</div>
						<% } %>

						<!-- Patreon -->
						<% if (oauthProviders.patreon?.isEnabled) { %>
						<% const patreonAccount = getLinkedAccount('patreon'); %>
						<div class="provider-card <%= patreonAccount ? 'is-linked' : '' %>">
							<div class="provider-info">
								<div class="provider-icon" style="color: #FF424D;">
									<i class="fab fa-patreon"></i>
								</div>
								<div>
									<p class="has-text-weight-bold">Patreon</p>
									<% if (patreonAccount) { %>
									<p class="is-size-7 has-text-grey"><%= patreonAccount.username %></p>
									<% } else { %>
									<p class="is-size-7 has-text-grey">Not connected - Link to sync pledges</p>
									<% } %>
								</div>
							</div>
							<% if (patreonAccount) { %>
							<button class="button is-small is-danger is-outlined" onclick="unlinkAccount('patreon')">Unlink</button>
							<% } else { %>
							<a class="button is-small is-info" href="/auth/patreon">Link</a>
							<% } %>
						</div>
						<% } %>

						<% if (!oauthProviders.google?.isEnabled && !oauthProviders.github?.isEnabled && !oauthProviders.twitch?.isEnabled && !oauthProviders.patreon?.isEnabled) { %>
						<p class="has-text-grey">No additional OAuth providers are enabled.</p>
						<% } %>
					</div>
				</div>
			</div>

			<!-- Server Profiles Section -->
			<div class="box mt-5">
				<h2 class="subtitle">
					<span class="icon"><i class="fa fa-server"></i></span>
					Server Profiles
				</h2>
				<p class="mb-4 has-text-grey">Create and manage custom profiles for each server you're in. These profiles are visible to other members on that server.</p>

				<div id="servers-list">
					<div class="servers-loading">
						<span class="icon"><i class="fa fa-spinner fa-spin"></i></span>
						<span>Loading your servers...</span>
					</div>
				</div>
			</div>
		</div>
	</section>

	<!-- Server Profile Edit Modal -->
	<div id="profile-modal" class="modal">
		<div class="modal-background" onclick="closeProfileModal()"></div>
		<div class="modal-card">
			<header class="modal-card-head">
				<p class="modal-card-title">
					<span class="icon"><i class="fa fa-user-edit"></i></span>
					<span id="modal-server-name">Edit Profile</span>
				</p>
				<button class="delete" aria-label="close" onclick="closeProfileModal()"></button>
			</header>
			<section class="modal-card-body">
				<input type="hidden" id="modal-server-id">
				
				<div class="notification is-info is-light">
					<span class="icon"><i class="fa fa-info-circle"></i></span>
					Add custom fields to your profile for this server. Other members can view these fields.
				</div>

				<div id="profile-fields-container">
					<!-- Fields will be dynamically added here -->
				</div>

				<button type="button" class="button is-small is-info is-outlined mt-3" onclick="addProfileField()">
					<span class="icon"><i class="fa fa-plus"></i></span>
					<span>Add Field</span>
				</button>

				<p class="help mt-3">Maximum 10 fields. Field names: 100 chars max. Values: 500 chars max.</p>
			</section>
			<footer class="modal-card-foot">
				<button class="button is-success" onclick="saveProfile()" id="save-profile-btn">
					<span class="icon"><i class="fa fa-save"></i></span>
					<span>Save Profile</span>
				</button>
				<button class="button is-danger is-outlined" onclick="deleteProfile()" id="delete-profile-btn">
					<span class="icon"><i class="fa fa-trash"></i></span>
					<span>Delete Profile</span>
				</button>
				<button class="button" onclick="closeProfileModal()">Cancel</button>
			</footer>
		</div>
	</div>

	<%- include('../partials/footer') %>

	<script>
	// Unlink OAuth account
	async function unlinkAccount(provider) {
		if (!confirm(`Are you sure you want to unlink your ${provider} account?`)) {
			return;
		}

		try {
			const response = await fetch(`/account/unlink/${provider}`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
			});

			if (response.ok) {
				location.reload();
			} else {
				alert('Failed to unlink account. Please try again.');
			}
		} catch (err) {
			alert('An error occurred. Please try again.');
		}
	}

	// Server profiles functionality
	let serversData = [];

	// Load servers on page load
	document.addEventListener('DOMContentLoaded', loadServers);

	async function loadServers() {
		const container = document.getElementById('servers-list');
		
		try {
			const response = await fetch('/account/servers');
			if (!response.ok) throw new Error('Failed to fetch servers');
			
			const data = await response.json();
			serversData = data.servers || [];
			
			if (serversData.length === 0) {
				container.innerHTML = `
					<div class="notification is-warning is-light">
						<span class="icon"><i class="fa fa-exclamation-triangle"></i></span>
						<span>You're not in any servers where the bot is present.</span>
					</div>
				`;
				return;
			}
			
			renderServersList();
		} catch (err) {
			console.error('Error loading servers:', err);
			container.innerHTML = `
				<div class="notification is-danger is-light">
					<span class="icon"><i class="fa fa-exclamation-circle"></i></span>
					<span>Failed to load servers. Please refresh the page.</span>
				</div>
			`;
		}
	}

	function renderServersList() {
		const container = document.getElementById('servers-list');
		
		const html = serversData.map(server => `
			<div class="server-card ${server.hasProfile ? 'has-profile' : ''}" onclick="openProfileModal('${server.id}')">
				<img src="${server.icon}" alt="${escapeHtml(server.name)}" class="server-icon" onerror="this.src='/static/img/discord-icon.png'">
				<div class="server-info">
					<h4>${escapeHtml(server.name)}</h4>
					<p>
						<span class="icon is-small"><i class="fa fa-users"></i></span>
						${server.memberCount} members
						<span class="ml-3 icon is-small"><i class="fa fa-crown"></i></span>
						${escapeHtml(server.owner)}
					</p>
				</div>
				<div>
					${server.hasProfile 
						? '<span class="tag is-success"><span class="icon is-small"><i class="fa fa-check"></i></span><span>Profile Set</span></span>' 
						: '<span class="tag is-light"><span class="icon is-small"><i class="fa fa-plus"></i></span><span>Add Profile</span></span>'
					}
				</div>
			</div>
		`).join('');
		
		container.innerHTML = html;
	}

	function openProfileModal(serverId) {
		const server = serversData.find(s => s.id === serverId);
		if (!server) return;
		
		document.getElementById('modal-server-id').value = serverId;
		document.getElementById('modal-server-name').textContent = `Edit Profile - ${server.name}`;
		
		const container = document.getElementById('profile-fields-container');
		container.innerHTML = '';
		
		// Load existing profile fields
		const profile = server.profile || {};
		const keys = Object.keys(profile);
		
		if (keys.length > 0) {
			keys.forEach(key => {
				addProfileField(key, profile[key]);
			});
		} else {
			// Add one empty field to start
			addProfileField();
		}
		
		document.getElementById('profile-modal').classList.add('is-active');
	}

	function closeProfileModal() {
		document.getElementById('profile-modal').classList.remove('is-active');
	}

	function addProfileField(name = '', value = '') {
		const container = document.getElementById('profile-fields-container');
		const fieldCount = container.querySelectorAll('.profile-field-row').length;
		
		if (fieldCount >= 10) {
			alert('Maximum 10 fields allowed');
			return;
		}
		
		const row = document.createElement('div');
		row.className = 'profile-field-row';
		row.innerHTML = `
			<input type="text" class="input field-name" placeholder="Field Name (e.g., Bio, Location)" maxlength="100" value="${escapeHtml(name)}">
			<input type="text" class="input field-value" placeholder="Value" maxlength="500" value="${escapeHtml(value)}">
			<button type="button" class="button is-small is-danger is-outlined" onclick="this.parentElement.remove()">
				<span class="icon"><i class="fa fa-times"></i></span>
			</button>
		`;
		
		container.appendChild(row);
	}

	async function saveProfile() {
		const serverId = document.getElementById('modal-server-id').value;
		const container = document.getElementById('profile-fields-container');
		const rows = container.querySelectorAll('.profile-field-row');
		
		const profile_fields = {};
		
		rows.forEach(row => {
			const name = row.querySelector('.field-name').value.trim();
			const value = row.querySelector('.field-value').value.trim();
			
			if (name && value) {
				profile_fields[name] = value;
			}
		});
		
		const btn = document.getElementById('save-profile-btn');
		btn.classList.add('is-loading');
		btn.disabled = true;
		
		try {
			const response = await fetch(`/account/servers/${serverId}/profile`, {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ profile_fields })
			});
			
			const data = await response.json();
			
			if (!response.ok) {
				throw new Error(data.error || 'Failed to save profile');
			}
			
			// Update local data
			const serverIndex = serversData.findIndex(s => s.id === serverId);
			if (serverIndex !== -1) {
				serversData[serverIndex].profile = profile_fields;
				serversData[serverIndex].hasProfile = Object.keys(profile_fields).length > 0;
			}
			
			renderServersList();
			closeProfileModal();
			
			// Show success notification
			showNotification('Profile saved successfully!', 'success');
		} catch (err) {
			alert(err.message || 'Failed to save profile');
		} finally {
			btn.classList.remove('is-loading');
			btn.disabled = false;
		}
	}

	async function deleteProfile() {
		if (!confirm('Are you sure you want to delete your profile for this server?')) {
			return;
		}
		
		const serverId = document.getElementById('modal-server-id').value;
		const btn = document.getElementById('delete-profile-btn');
		btn.classList.add('is-loading');
		btn.disabled = true;
		
		try {
			const response = await fetch(`/account/servers/${serverId}/profile`, {
				method: 'DELETE'
			});
			
			if (!response.ok) {
				const data = await response.json();
				throw new Error(data.error || 'Failed to delete profile');
			}
			
			// Update local data
			const serverIndex = serversData.findIndex(s => s.id === serverId);
			if (serverIndex !== -1) {
				serversData[serverIndex].profile = {};
				serversData[serverIndex].hasProfile = false;
			}
			
			renderServersList();
			closeProfileModal();
			
			showNotification('Profile deleted successfully!', 'info');
		} catch (err) {
			alert(err.message || 'Failed to delete profile');
		} finally {
			btn.classList.remove('is-loading');
			btn.disabled = false;
		}
	}

	function escapeHtml(text) {
		const div = document.createElement('div');
		div.textContent = text;
		return div.innerHTML;
	}

	function showNotification(message, type = 'info') {
		const notification = document.createElement('div');
		notification.className = `notification is-${type} is-light`;
		notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
		notification.innerHTML = `
			<button class="delete" onclick="this.parentElement.remove()"></button>
			${escapeHtml(message)}
		`;
		document.body.appendChild(notification);
		
		setTimeout(() => {
			notification.remove();
		}, 3000);
	}

	// Close modal on escape key
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			closeProfileModal();
		}
	});
	</script>
</body>
</html>
