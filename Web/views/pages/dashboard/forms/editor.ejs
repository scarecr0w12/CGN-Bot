<%- include('../../../partials/header', { title: title }) %>
<%- include('../../../partials/dashboard/sidebar') %>

<div class="dashboard-content">
    <div class="dashboard-header">
        <h1><i class="fas fa-<%= isEdit ? 'edit' : 'plus' %>"></i> <%= isEdit ? 'Edit' : 'Create' %> Form</h1>
        <a href="/dashboard/<%= serverDocument._id %>/forms" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Forms
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            <form id="formEditor">
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-group">
                        <label>Form Name *</label>
                        <input type="text" name="name" value="<%= form ? form.name : '' %>" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description" rows="3"><%= form ? form.description || '' : '' %></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Form Fields</h3>
                    <div id="fieldsContainer">
                        <% if (form && form.fields) { %>
                            <% form.fields.forEach((field, index) => { %>
                                <div class="field-item" data-index="<%= index %>">
                                    <div class="field-header">
                                        <span class="field-label"><%= field.label %></span>
                                        <div class="field-actions">
                                            <button type="button" class="btn-icon" onclick="moveField(<%= index %>, -1)"><i class="fas fa-arrow-up"></i></button>
                                            <button type="button" class="btn-icon" onclick="moveField(<%= index %>, 1)"><i class="fas fa-arrow-down"></i></button>
                                            <button type="button" class="btn-icon" onclick="editField(<%= index %>)"><i class="fas fa-edit"></i></button>
                                            <button type="button" class="btn-icon" onclick="deleteField(<%= index %>)"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } %>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="showFieldEditor()">
                        <i class="fas fa-plus"></i> Add Field
                    </button>
                </div>

                <div class="form-section">
                    <h3>Channels & Settings</h3>
                    <div class="form-group">
                        <label>Submit Channel</label>
                        <select name="submit_channel">
                            <option value="">None</option>
                            <% channels.forEach(channel => { %>
                                <option value="<%= channel.id %>" <%= form && form.submit_channel === channel.id ? 'selected' : '' %>>
                                    #<%= channel.name %>
                                </option>
                            <% }) %>
                        </select>
                        <small>Channel to send public submission notifications</small>
                    </div>
                    <div class="form-group">
                        <label>Review Channel</label>
                        <select name="review_channel">
                            <option value="">None</option>
                            <% channels.forEach(channel => { %>
                                <option value="<%= channel.id %>" <%= form && form.review_channel === channel.id ? 'selected' : '' %>>
                                    #<%= channel.name %>
                                </option>
                            <% }) %>
                        </select>
                        <small>Channel for staff to review submissions</small>
                    </div>
                    <div class="form-group">
                        <label>Auto-Assign Role</label>
                        <select name="auto_role_id">
                            <option value="">None</option>
                            <% roles.forEach(role => { %>
                                <option value="<%= role.id %>" <%= form && form.auto_role_id === role.id ? 'selected' : '' %>>
                                    <%= role.name %>
                                </option>
                            <% }) %>
                        </select>
                        <small>Role to assign when application is approved</small>
                    </div>
                    <div class="form-group">
                        <label>Webhook URL (Optional)</label>
                        <input type="url" name="webhook_url" value="<%= form ? form.webhook_url || '' : '' %>">
                        <small>Send submissions to external service</small>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> <%= isEdit ? 'Update' : 'Create' %> Form
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Field Editor Modal -->
<div id="fieldEditorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="fieldEditorTitle">Add Field</h3>
            <span class="close" onclick="closeFieldEditor()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="fieldEditorForm">
                <input type="hidden" name="editIndex" value="-1">
                <div class="form-group">
                    <label>Field Label *</label>
                    <input type="text" name="label" required>
                </div>
                <div class="form-group">
                    <label>Field Type *</label>
                    <select name="type" onchange="updateFieldOptions()" required>
                        <option value="short_text">Short Text</option>
                        <option value="long_text">Long Text</option>
                        <option value="select">Dropdown</option>
                        <option value="multi_select">Multiple Choice</option>
                    </select>
                </div>
                <div class="form-group" id="optionsGroup" style="display:none;">
                    <label>Options (one per line)</label>
                    <textarea name="options" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="required">
                        Required Field
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeFieldEditor()">Cancel</button>
            <button class="btn btn-primary" onclick="saveField()">Save Field</button>
        </div>
    </div>
</div>

<style>
.form-section {
    margin-bottom: 30px;
    padding-bottom: 30px;
    border-bottom: 1px solid var(--border-color);
}
.form-section:last-of-type {
    border-bottom: none;
}
.form-section h3 {
    margin-bottom: 20px;
    color: var(--text-primary);
}
.field-item {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}
.field-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.field-label {
    font-weight: 600;
}
.field-actions {
    display: flex;
    gap: 5px;
}
.btn-icon {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 4px;
}
.btn-icon:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}
.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 30px;
}
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
}
.modal-content {
    background-color: var(--bg-secondary);
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
}
.modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-body { padding: 20px; }
.modal-footer {
    padding: 20px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}
.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}
.close:hover { color: #fff; }
</style>

<script>
let fields = <%= form && form.fields ? JSON.stringify(form.fields) : '[]' %>;

function renderFields() {
    const container = document.getElementById('fieldsContainer');
    container.innerHTML = fields.map((field, index) => `
        <div class="field-item" data-index="${index}">
            <div class="field-header">
                <span class="field-label">${field.label} ${field.required ? '*' : ''}</span>
                <div class="field-actions">
                    <button type="button" class="btn-icon" onclick="moveField(${index}, -1)"><i class="fas fa-arrow-up"></i></button>
                    <button type="button" class="btn-icon" onclick="moveField(${index}, 1)"><i class="fas fa-arrow-down"></i></button>
                    <button type="button" class="btn-icon" onclick="editField(${index})"><i class="fas fa-edit"></i></button>
                    <button type="button" class="btn-icon" onclick="deleteField(${index})"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>
    `).join('');
}

function showFieldEditor() {
    document.getElementById('fieldEditorTitle').textContent = 'Add Field';
    document.getElementById('fieldEditorForm').reset();
    document.querySelector('[name="editIndex"]').value = '-1';
    document.getElementById('fieldEditorModal').style.display = 'block';
}

function closeFieldEditor() {
    document.getElementById('fieldEditorModal').style.display = 'none';
}

function updateFieldOptions() {
    const type = document.querySelector('[name="type"]').value;
    const optionsGroup = document.getElementById('optionsGroup');
    optionsGroup.style.display = ['select', 'multi_select'].includes(type) ? 'block' : 'none';
}

function editField(index) {
    const field = fields[index];
    document.getElementById('fieldEditorTitle').textContent = 'Edit Field';
    document.querySelector('[name="editIndex"]').value = index;
    document.querySelector('[name="label"]').value = field.label;
    document.querySelector('[name="type"]').value = field.type;
    document.querySelector('[name="required"]').checked = field.required;
    if (field.options) {
        document.querySelector('[name="options"]').value = field.options.join('\n');
    }
    updateFieldOptions();
    document.getElementById('fieldEditorModal').style.display = 'block';
}

function saveField() {
    const form = document.getElementById('fieldEditorForm');
    const formData = new FormData(form);
    const editIndex = parseInt(formData.get('editIndex'));
    
    const field = {
        label: formData.get('label'),
        type: formData.get('type'),
        required: formData.get('required') === 'on',
    };
    
    if (['select', 'multi_select'].includes(field.type)) {
        const options = formData.get('options').split('\n').filter(o => o.trim());
        if (options.length === 0) {
            alert('Please add at least one option');
            return;
        }
        field.options = options;
    }
    
    if (editIndex >= 0) {
        fields[editIndex] = field;
    } else {
        fields.push(field);
    }
    
    renderFields();
    closeFieldEditor();
}

function moveField(index, direction) {
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= fields.length) return;
    [fields[index], fields[newIndex]] = [fields[newIndex], fields[index]];
    renderFields();
}

function deleteField(index) {
    if (!confirm('Delete this field?')) return;
    fields.splice(index, 1);
    renderFields();
}

document.getElementById('formEditor').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    data.fields = JSON.stringify(fields);
    
    const url = <%= isEdit ? 
        `\`/dashboard/${serverDocument._id}/forms/${form._id}\`` : 
        `\`/dashboard/${serverDocument._id}/forms\`` %>;
    const method = <%= isEdit ? '"PUT"' : '"POST"' %>;
    
    try {
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        
        const result = await response.json();
        if (result.success) {
            window.location.href = `/dashboard/<%= serverDocument._id %>/forms`;
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Failed to save form: ' + error.message);
    }
});
</script>

<%- include('../../../partials/footer') %>
