<!DOCTYPE html>
<html lang="en">
<head>
	<title>Ticket #<%= configData.ticket.ticket_number %> - <%= serverData.name %> Maintainer Console</title>
	<%- include('../partials/head') %>
	<style>
		.ticket-header {
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.08);
			padding: 1.5rem;
			margin-bottom: 1.5rem;
		}
		.ticket-header-top {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			flex-wrap: wrap;
			gap: 1rem;
			margin-bottom: 1rem;
		}
		.ticket-title {
			font-size: 1.5rem;
			font-weight: 700;
			color: #1f2937;
			margin-bottom: 0.5rem;
		}
		.ticket-meta {
			display: flex;
			align-items: center;
			gap: 1rem;
			flex-wrap: wrap;
		}
		.ticket-user {
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}
		.ticket-avatar {
			width: 32px;
			height: 32px;
			border-radius: 50%;
		}
		.ticket-number {
			font-family: monospace;
			color: #6b7280;
		}
		
		.status-badge {
			display: inline-block;
			padding: 0.25rem 0.75rem;
			border-radius: 999px;
			font-size: 0.75rem;
			font-weight: 600;
			text-transform: uppercase;
		}
		.status-open { background: #dbeafe; color: #1d4ed8; }
		.status-in_progress { background: #fef3c7; color: #d97706; }
		.status-awaiting_response { background: #e0e7ff; color: #4f46e5; }
		.status-on_hold { background: #f3f4f6; color: #6b7280; }
		.status-resolved { background: #d1fae5; color: #059669; }
		.status-closed { background: #e5e7eb; color: #6b7280; }
		
		.priority-badge {
			display: inline-block;
			padding: 0.25rem 0.5rem;
			border-radius: 4px;
			font-size: 0.7rem;
			font-weight: 600;
			text-transform: uppercase;
		}
		.priority-low { background: #f3f4f6; color: #6b7280; }
		.priority-normal { background: #dbeafe; color: #1d4ed8; }
		.priority-high { background: #fef3c7; color: #d97706; }
		.priority-urgent { background: #fee2e2; color: #dc2626; }
		
		.category-badge {
			display: inline-block;
			padding: 0.25rem 0.5rem;
			border-radius: 4px;
			font-size: 0.7rem;
			font-weight: 500;
		}
		.category-general { background: #f3f4f6; color: #6b7280; }
		.category-bug { background: #fef2f2; color: #dc2626; }
		.category-feature { background: #eff6ff; color: #2563eb; }
		.category-billing { background: #f0fdf4; color: #16a34a; }
		.category-account { background: #fefce8; color: #ca8a04; }
		.category-other { background: #f5f3ff; color: #7c3aed; }
		
		.messages-container {
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.08);
			overflow: hidden;
		}
		.messages-header {
			padding: 1rem;
			border-bottom: 1px solid #e5e7eb;
			font-weight: 600;
		}
		.messages-list {
			max-height: 500px;
			overflow-y: auto;
			padding: 1rem;
		}
		.message-item {
			display: flex;
			gap: 0.75rem;
			margin-bottom: 1rem;
			padding-bottom: 1rem;
			border-bottom: 1px solid #f3f4f6;
		}
		.message-item:last-child {
			border-bottom: none;
			margin-bottom: 0;
			padding-bottom: 0;
		}
		.message-avatar {
			width: 36px;
			height: 36px;
			border-radius: 50%;
			flex-shrink: 0;
		}
		.message-content {
			flex: 1;
		}
		.message-header {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			margin-bottom: 0.25rem;
		}
		.message-author {
			font-weight: 600;
			color: #1f2937;
		}
		.message-author.is-staff {
			color: #3273dc;
		}
		.message-time {
			font-size: 0.75rem;
			color: #9ca3af;
		}
		.message-body {
			color: #4b5563;
			line-height: 1.6;
			white-space: pre-wrap;
		}
		.message-item.is-system {
			background: #f9fafb;
			border-radius: 8px;
			padding: 0.75rem;
			margin-bottom: 0.5rem;
		}
		.message-item.is-system .message-body {
			font-style: italic;
			color: #6b7280;
		}
		.staff-badge {
			font-size: 0.65rem;
			background: #3273dc;
			color: white;
			padding: 0.1rem 0.4rem;
			border-radius: 4px;
			font-weight: 600;
		}
		
		.reply-form {
			padding: 1rem;
			border-top: 1px solid #e5e7eb;
			background: #f9fafb;
		}
		
		.sidebar-card {
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.08);
			padding: 1rem;
			margin-bottom: 1rem;
		}
		.sidebar-card h4 {
			font-weight: 600;
			margin-bottom: 0.75rem;
			color: #374151;
		}
		.sidebar-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0.5rem 0;
			border-bottom: 1px solid #f3f4f6;
		}
		.sidebar-item:last-child {
			border-bottom: none;
		}
		.sidebar-label {
			font-size: 0.85rem;
			color: #6b7280;
		}
		.sidebar-value {
			font-weight: 500;
			color: #1f2937;
		}
		
		.internal-notes {
			background: #fffbeb;
			border: 1px solid #fcd34d;
			border-radius: 8px;
			padding: 1rem;
			margin-bottom: 1rem;
		}
		.internal-notes h4 {
			color: #92400e;
			font-weight: 600;
			margin-bottom: 0.5rem;
		}
		.internal-notes textarea {
			width: 100%;
			min-height: 80px;
			border: 1px solid #fcd34d;
			border-radius: 4px;
			padding: 0.5rem;
			font-size: 0.9rem;
		}
	</style>
</head>
<body>
	<%- include('../partials/dashboard-header') %>
	<%- include('../partials/dashboard-socket-updates') %>

	<section class="section is-white">
		<div class="container">
			<div class="columns">
				<div id="menu" class="column is-one-quarter">
					<%- include('../partials/maintainer-menu') %>
				</div>
				<div class="column">
					<nav class="breadcrumb mb-4" aria-label="breadcrumbs">
						<ul>
							<li><a href="/dashboard/maintainer/tickets">Support Tickets</a></li>
							<li class="is-active"><a href="#" aria-current="page">Ticket #<%= configData.ticket.ticket_number %></a></li>
						</ul>
					</nav>
					
					<div class="columns">
						<!-- Main Content -->
						<div class="column is-two-thirds">
							<!-- Ticket Header -->
							<div class="ticket-header">
								<div class="ticket-header-top">
									<div>
										<h1 class="ticket-title"><%= configData.ticket.subject %></h1>
										<div class="ticket-meta">
											<span class="ticket-number">#<%= configData.ticket.ticket_number %></span>
											<div class="ticket-user">
												<img src="<%= configData.ticket.user_avatar %>" alt="" class="ticket-avatar">
												<span><%= configData.ticket.username %></span>
											</div>
											<span class="has-text-grey-light">
												<i class="fa fa-clock"></i>
												<%= new Date(configData.ticket.created_at).toLocaleDateString() %>
											</span>
										</div>
									</div>
									<div>
										<span class="status-badge status-<%= configData.ticket.status %>"><%= configData.ticket.status.replace(/_/g, ' ') %></span>
										<span class="priority-badge priority-<%= configData.ticket.priority %>"><%= configData.ticket.priority %></span>
										<span class="category-badge category-<%= configData.ticket.category %>"><%= configData.ticket.category %></span>
									</div>
								</div>
							</div>

							<!-- Messages -->
							<div class="messages-container">
								<div class="messages-header">
									<i class="fa fa-comments"></i>
									Conversation (<%= configData.messages.length %> messages)
								</div>
								<div class="messages-list" id="messages-list">
									<% if (configData.messages && configData.messages.length > 0) { %>
										<% configData.messages.forEach(msg => { %>
										<div class="message-item <%= msg.is_system_message ? 'is-system' : '' %>">
											<img src="<%= msg.author_avatar %>" alt="" class="message-avatar">
											<div class="message-content">
												<div class="message-header">
													<span class="message-author <%= msg.is_staff ? 'is-staff' : '' %>"><%= msg.author_username %></span>
													<% if (msg.is_staff) { %><span class="staff-badge">STAFF</span><% } %>
													<span class="message-time"><%= new Date(msg.created_at).toLocaleString() %></span>
												</div>
												<div class="message-body"><%= msg.content %></div>
											</div>
										</div>
										<% }); %>
									<% } else { %>
									<p class="has-text-grey-light has-text-centered py-4">No messages yet</p>
									<% } %>
								</div>
								
								<% if (configData.ticket.status !== 'closed') { %>
								<div class="reply-form">
									<div class="field">
										<label class="label is-small">Reply to Ticket</label>
										<div class="control">
											<textarea id="reply-content" class="textarea" placeholder="Type your reply..." rows="3"></textarea>
										</div>
									</div>
									<div class="field is-grouped">
										<div class="control">
											<button class="button is-primary" id="send-reply-btn">
												<span class="icon"><i class="fa fa-paper-plane"></i></span>
												<span>Send Reply</span>
											</button>
										</div>
										<div class="control">
											<button class="button is-success" id="close-ticket-btn">
												<span class="icon"><i class="fa fa-check"></i></span>
												<span>Close Ticket</span>
											</button>
										</div>
									</div>
								</div>
								<% } else { %>
								<div class="reply-form has-text-centered">
									<p class="has-text-grey">This ticket is closed.</p>
									<button class="button is-warning is-small mt-2" id="reopen-ticket-btn">
										<span class="icon"><i class="fa fa-undo"></i></span>
										<span>Reopen Ticket</span>
									</button>
								</div>
								<% } %>
							</div>
						</div>
						
						<!-- Sidebar -->
						<div class="column is-one-third">
							<!-- Actions -->
							<div class="sidebar-card">
								<h4><i class="fa fa-cog"></i> Actions</h4>
								<div class="buttons">
									<a href="/dashboard/maintainer/tickets/<%= configData.ticket._id %>/transcript" class="button is-small is-fullwidth" target="_blank">
										<span class="icon"><i class="fa fa-download"></i></span>
										<span>Download Transcript</span>
									</a>
									<button class="button is-small is-danger is-fullwidth" id="delete-ticket-btn">
										<span class="icon"><i class="fa fa-trash"></i></span>
										<span>Delete Ticket</span>
									</button>
								</div>
							</div>
							
							<!-- Details -->
							<div class="sidebar-card">
								<h4><i class="fa fa-info-circle"></i> Details</h4>
								<div class="sidebar-item">
									<span class="sidebar-label">Status</span>
									<div class="select is-small">
										<select id="ticket-status">
											<% configData.statuses.forEach(s => { %>
											<option value="<%= s %>" <%= configData.ticket.status === s ? 'selected' : '' %>><%= s.replace(/_/g, ' ') %></option>
											<% }); %>
										</select>
									</div>
								</div>
								<div class="sidebar-item">
									<span class="sidebar-label">Priority</span>
									<div class="select is-small">
										<select id="ticket-priority">
											<% configData.priorities.forEach(p => { %>
											<option value="<%= p %>" <%= configData.ticket.priority === p ? 'selected' : '' %>><%= p %></option>
											<% }); %>
										</select>
									</div>
								</div>
								<div class="sidebar-item">
									<span class="sidebar-label">Category</span>
									<div class="select is-small">
										<select id="ticket-category">
											<% configData.categories.forEach(c => { %>
											<option value="<%= c %>" <%= configData.ticket.category === c ? 'selected' : '' %>><%= c %></option>
											<% }); %>
										</select>
									</div>
								</div>
								<div class="sidebar-item">
									<span class="sidebar-label">Assigned To</span>
									<div class="select is-small">
										<select id="ticket-assigned">
											<option value="">Unassigned</option>
											<% configData.maintainers.forEach(m => { %>
											<option value="<%= m.id %>" <%= configData.ticket.assigned_to === m.id ? 'selected' : '' %>><%= m.username %></option>
											<% }); %>
										</select>
									</div>
								</div>
								<button class="button is-small is-primary is-fullwidth mt-3" id="save-details-btn">
									<span class="icon"><i class="fa fa-save"></i></span>
									<span>Save Changes</span>
								</button>
							</div>
							
							<!-- Internal Notes -->
							<div class="internal-notes">
								<h4><i class="fa fa-sticky-note"></i> Internal Notes</h4>
								<p class="is-size-7 has-text-grey mb-2">Only visible to staff</p>
								<textarea id="internal-notes" placeholder="Add internal notes..."><%= configData.ticket.internal_notes || '' %></textarea>
								<button class="button is-small is-warning is-fullwidth mt-2" id="save-notes-btn">
									<span class="icon"><i class="fa fa-save"></i></span>
									<span>Save Notes</span>
								</button>
							</div>
							
							<!-- Timeline -->
							<div class="sidebar-card">
								<h4><i class="fa fa-history"></i> Timeline</h4>
								<div class="sidebar-item">
									<span class="sidebar-label">Created</span>
									<span class="sidebar-value"><%= new Date(configData.ticket.created_at).toLocaleDateString() %></span>
								</div>
								<div class="sidebar-item">
									<span class="sidebar-label">Last Activity</span>
									<span class="sidebar-value"><%= new Date(configData.ticket.last_activity_at || configData.ticket.created_at).toLocaleDateString() %></span>
								</div>
								<% if (configData.ticket.closed_at) { %>
								<div class="sidebar-item">
									<span class="sidebar-label">Closed</span>
									<span class="sidebar-value"><%= new Date(configData.ticket.closed_at).toLocaleDateString() %></span>
								</div>
								<% } %>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>

	<%- include('../partials/footer') %>
	<%- include('../partials/scroll-top-button') %>

	<script>
	document.addEventListener('turbolinks:load', function() {
		const ticketId = '<%= configData.ticket._id %>';
		
		// Scroll to bottom of messages
		const messagesList = document.getElementById('messages-list');
		if (messagesList) {
			messagesList.scrollTop = messagesList.scrollHeight;
		}
		
		// Send reply
		const sendReplyBtn = document.getElementById('send-reply-btn');
		if (sendReplyBtn) {
			sendReplyBtn.addEventListener('click', async function() {
				const content = document.getElementById('reply-content').value.trim();
				if (!content) {
					alert('Please enter a reply');
					return;
				}
				
				this.classList.add('is-loading');
				try {
					const response = await fetch('/dashboard/maintainer/tickets/reply', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ id: ticketId, content })
					});
					
					if (!response.ok) throw new Error('Failed to send reply');
					
					// Reload page to show new message
					window.location.reload();
				} catch (err) {
					alert('Failed to send reply: ' + err.message);
				} finally {
					this.classList.remove('is-loading');
				}
			});
		}
		
		// Close ticket
		const closeTicketBtn = document.getElementById('close-ticket-btn');
		if (closeTicketBtn) {
			closeTicketBtn.addEventListener('click', async function() {
				const resolutionNotes = prompt('Enter resolution notes (optional):');
				if (resolutionNotes === null) return; // Cancelled
				
				this.classList.add('is-loading');
				try {
					const response = await fetch('/dashboard/maintainer/tickets/close', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ id: ticketId, resolution_notes: resolutionNotes })
					});
					
					if (!response.ok) throw new Error('Failed to close ticket');
					
					window.location.reload();
				} catch (err) {
					alert('Failed to close ticket: ' + err.message);
				} finally {
					this.classList.remove('is-loading');
				}
			});
		}
		
		// Reopen ticket
		const reopenTicketBtn = document.getElementById('reopen-ticket-btn');
		if (reopenTicketBtn) {
			reopenTicketBtn.addEventListener('click', async function() {
				this.classList.add('is-loading');
				try {
					const response = await fetch('/dashboard/maintainer/tickets/update', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ id: ticketId, status: 'open' })
					});
					
					if (!response.ok) throw new Error('Failed to reopen ticket');
					
					window.location.reload();
				} catch (err) {
					alert('Failed to reopen ticket: ' + err.message);
				} finally {
					this.classList.remove('is-loading');
				}
			});
		}
		
		// Save details
		const saveDetailsBtn = document.getElementById('save-details-btn');
		if (saveDetailsBtn) {
			saveDetailsBtn.addEventListener('click', async function() {
				const status = document.getElementById('ticket-status').value;
				const priority = document.getElementById('ticket-priority').value;
				const category = document.getElementById('ticket-category').value;
				const assignedTo = document.getElementById('ticket-assigned').value;
				
				this.classList.add('is-loading');
				try {
					const response = await fetch('/dashboard/maintainer/tickets/update', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ 
							id: ticketId, 
							status, 
							priority, 
							category, 
							assigned_to: assignedTo 
						})
					});
					
					if (!response.ok) throw new Error('Failed to update ticket');
					
					window.location.reload();
				} catch (err) {
					alert('Failed to update ticket: ' + err.message);
				} finally {
					this.classList.remove('is-loading');
				}
			});
		}
		
		// Save internal notes
		const saveNotesBtn = document.getElementById('save-notes-btn');
		if (saveNotesBtn) {
			saveNotesBtn.addEventListener('click', async function() {
				const notes = document.getElementById('internal-notes').value;
				
				this.classList.add('is-loading');
				try {
					const response = await fetch('/dashboard/maintainer/tickets/update', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ id: ticketId, internal_notes: notes })
					});
					
					if (!response.ok) throw new Error('Failed to save notes');
					
					alert('Notes saved!');
				} catch (err) {
					alert('Failed to save notes: ' + err.message);
				} finally {
					this.classList.remove('is-loading');
				}
			});
		}
		
		// Delete ticket
		const deleteTicketBtn = document.getElementById('delete-ticket-btn');
		if (deleteTicketBtn) {
			deleteTicketBtn.addEventListener('click', async function() {
				if (!confirm('Are you sure you want to delete this ticket? This cannot be undone.')) return;
				
				this.classList.add('is-loading');
				try {
					const response = await fetch('/dashboard/maintainer/tickets/delete', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ id: ticketId })
					});
					
					if (!response.ok) throw new Error('Failed to delete ticket');
					
					window.location.href = '/dashboard/maintainer/tickets';
				} catch (err) {
					alert('Failed to delete ticket: ' + err.message);
				} finally {
					this.classList.remove('is-loading');
				}
			});
		}
	});
	</script>
</body>
</html>
