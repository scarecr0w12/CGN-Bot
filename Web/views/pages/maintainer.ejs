<!DOCTYPE html>
<html lang="en">
<head>
	<title><%= serverData.name %> Maintainer Console</title>
	<%- include('../partials/head') %>
</head>
<body>
	<%- include('../partials/dashboard-header') %>

	<section class="section is-white">
		<div class="container">
			<div class="columns">
				<div id="menu" class="column is-one-quarter">
					<%- include('../partials/maintainer-menu') %>
				</div>
				<div class="column">
					<article class="message is-primary">
						<div class="message-header">
							<p>Welcome to the Skynet <strong>maintainer console</strong>!</p>
						</div>
						<div class="message-body">
							Maintainers can configure Skynet across <strong>all servers</strong> from here, including the message in the homepage banner, commands disabled by default, and the global blocklist. The list of options is shown in the menu on the left. This page shows an <strong>overview</strong> of the bot's activity.
						</div>
					</article>
					<div class="columns">
						<div class="column">
							<a class="box notification is-white" href="/activity">
								<div class="heading">
									<span class="icon is-small">
										<i class="fas fa-server"></i>
									</span>
									Server<%= pageData.serverCount === 1 ? "" : "s" %>
								</div>
								<div class="title">
                                    <%= pageData.serverCount %>
								</div>
								<div class="heading">
									<span class="icon is-small">
										<i class="fas fa-user"></i>
									</span>
									User<%= pageData.userCount === 1 ? "" : "s" %>
								</div>
								<div class="title">
                                    <%= pageData.userCount %>
								</div>
							</a>
						</div>
						<div class="column">
							<a class="box notification is-white" onclick="$('.traffic-chart-container').slideToggle();">
								<div class="heading">
									<span class="icon is-small">
										<i class="fas fa-comments"></i>
									</span>
									Message<%= pageData.totalMessageCount === 1 ? "" : "s" %> today
								</div>
								<div class="title">
                                    <%= pageData.totalMessageCount %>
								</div>
								<div class="heading">
									<span class="icon is-small">
										<i class="fas fa-eye"></i>
									</span>
									Current Session Views
								</div>
								<div class="title">
                                    <%= pageData.trafficData.current.pageViews %>
								</div>
								<div class="heading">
									<span class="icon is-small">
										<i class="fas fa-users"></i>
									</span>
									Unique Visitors (Session)
								</div>
								<div class="title">
                                    <%= pageData.trafficData.current.uniqueUsers %>
								</div>
							</a>
						</div>
						<div class="column">
							<a class="box notification is-white" href="/dashboard/maintainer/management/shards">
								<div class="heading">
									<span class="icon is-small">
										<i class="fas fa-puzzle-piece"></i>
									</span>
									Current Shard
								</div>
								<div class="title">
                                    <%= parseInt(pageData.currentShard) + 1 %>/<%= configData.shardCount %>
								</div>
								<div class="heading">
									<span class="icon is-small">
										<i class="fas fa-clock"></i>
									</span>
									Shard uptime
								</div>
								<div class="title">
                                    <%= pageData.roundedUptime %>
								</div>
							</a>
						</div>
						<div class="column">
							<a class="box notification <% if (configData.disabled) { %>is-dark<% } else if (!configData.utd) { %>is-info<% } else { %>is-white<% } %>"<% if (accessPrivileges.includes("management")) { %> href="/dashboard/maintainer/management/version"<% } %>>
								<div class="heading">
									<span class="icon is-small">
										<i class="fas fa-code-fork"></i>
									</span>
									Installed Version
								</div>
								<div class="title">
                                    <%= configData.version %>
								</div>
								<div class="heading">
									<span class="icon is-small">
										<i class="fas fa-arrow-circle-up"></i>
									</span>
									Latest Version
								</div>
								<div class="title">
                                    <% if (configData.disabled) { %> <%= configData.version %> <% } else { %> <%= configData.currentVersion %> <% } %>
								</div>
							</a>
						</div>
					</div>
					<!-- Global Actions -->
					<article class="message is-info" style="margin-top: 1.5rem;">
						<div class="message-header">
							<p><span class="icon"><i class="fas fa-cogs"></i></span> Global Actions</p>
						</div>
						<div class="message-body">
							<p style="margin-bottom: 1rem;">
								<strong>Global Member Scan</strong> - Index all members from all servers into the database so they appear in user search on the Activity page.
							</p>
							<button id="global-scan-btn" class="button is-primary" onclick="SkynetUtil.globalScan()">
								<span class="icon"><i class="fas fa-refresh"></i></span>
								<span>Scan All Servers</span>
							</button>
							<div id="global-scan-result" style="margin-top: 1rem; display: none;"></div>
						</div>
					</article>

					<script>
					SkynetUtil.globalScan = async () => {
						const btn = document.getElementById('global-scan-btn');
						const resultDiv = document.getElementById('global-scan-result');
						btn.classList.add('is-loading');
						btn.disabled = true;
						resultDiv.style.display = 'none';

						try {
							const response = await fetch('/dashboard/maintainer/global-scan', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' }
							});
							const data = await response.json();

							if (data.success) {
								let html = '<div class="notification is-success">' +
									'<strong>Global Scan Complete!</strong><br>' +
									'Servers Scanned: ' + data.serversScanned + '/' + data.totalServers + '<br>' +
									'Total Members: ' + data.totalMembers + '<br>' +
									'New Users Created: ' + data.created + '<br>' +
									'Usernames Updated: ' + data.updated + '<br>' +
									'Already Up-to-date: ' + data.skipped;
								if (data.errors && data.errors.length > 0) {
									html += '<br><br><strong>Errors:</strong><br>';
									data.errors.forEach(e => { html += e.server + ': ' + e.error + '<br>'; });
								}
								html += '</div>';
								resultDiv.innerHTML = html;
							} else {
								resultDiv.innerHTML = '<div class="notification is-danger">Error: ' + (data.error || 'Unknown error') + '</div>';
							}
						} catch (err) {
							resultDiv.innerHTML = '<div class="notification is-danger">Error: ' + err.message + '</div>';
						}

						btn.classList.remove('is-loading');
						btn.disabled = false;
						resultDiv.style.display = 'block';
					};
					</script>

					<div class="traffic-chart-container">
						<h4 class="title is-4">
							<span class="icon"><i class="fas fa-chart-line"></i></span>
							Web Interface Traffic
						</h4>
						<div class="box">
							<h4 class="subtitle">Last 24 Hours (Hourly)</h4>
							<% if (pageData.trafficData.day.length === 0) { %>
								<p class="has-text-grey">No traffic data available for today yet.</p>
							<% } else if (pageData.trafficData.day.length === 1) { %>
								<p class="has-text-grey">Only 1 data point available. More data needed for chart.</p>
								<p><strong>Page Views:</strong> <%= pageData.trafficData.day[0].pageViews %> | <strong>Authenticated:</strong> <%= pageData.trafficData.day[0].authViews %> | <strong>Unique:</strong> <%= pageData.trafficData.day[0].uniqueUsers %></p>
							<% } else { %>
								<div id="traffic-chart-day" class="traffic-chart" style="height: 250px;"></div>
							<% } %>
						</div>
						<div class="box">
							<h4 class="subtitle">Last 7 Days (Daily)</h4>
							<% if (pageData.trafficData.week.length === 0) { %>
								<p class="has-text-grey">No traffic data available for this week yet.</p>
							<% } else { %>
								<div id="traffic-chart-week" class="traffic-chart" style="height: 250px;"></div>
							<% } %>
						</div>
						<div class="box">
							<h4 class="subtitle">Last 30 Days (Daily)</h4>
							<% if (pageData.trafficData.month.length === 0) { %>
								<p class="has-text-grey">No traffic data available for this month yet.</p>
							<% } else { %>
								<div id="traffic-chart-month" class="traffic-chart" style="height: 250px;"></div>
							<% } %>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>

	<%- include('../partials/footer') %>
	<%- include('../partials/scroll-top-button') %>
	<script>
	document.addEventListener("DOMContentLoaded", function() {
	  function formatDate(ts) {
		const d = new Date(ts);
		return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
	  }
	  function formatHour(ts) {
		const d = new Date(ts);
		return d.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
	  }
	  <% if (pageData.trafficData.month.length > 0) { %>
	  new Morris.Line({
		element: "traffic-chart-month",
		lineColors: ["#00d1b2", "#ffdd57", "#3273dc"],
		data: <%- JSON.stringify(pageData.trafficData.month) %>,
		xkey: "_id",
		ykeys: ["pageViews", "authViews", "uniqueUsers"],
		labels: ["Page Views", "Authenticated", "Unique Visitors"],
		dateFormat: formatDate,
		xLabelFormat: formatDate,
		parseTime: true,
		resize: true,
		hideHover: 'auto',
		smooth: true,
		pointSize: 4
	  });
	  <% } %>
	  <% if (pageData.trafficData.week.length > 0) { %>
	  new Morris.Line({
		element: "traffic-chart-week",
		lineColors: ["#00d1b2", "#ffdd57", "#3273dc"],
		data: <%- JSON.stringify(pageData.trafficData.week) %>,
		xkey: "_id",
		ykeys: ["pageViews", "authViews", "uniqueUsers"],
		labels: ["Page Views", "Authenticated", "Unique Visitors"],
		dateFormat: formatDate,
		xLabelFormat: formatDate,
		parseTime: true,
		resize: true,
		hideHover: 'auto',
		smooth: true,
		pointSize: 4
	  });
	  <% } %>
	  <% if (pageData.trafficData.day.length > 1) { %>
	  new Morris.Line({
		element: "traffic-chart-day",
		lineColors: ["#00d1b2", "#ffdd57", "#3273dc"],
		data: <%- JSON.stringify(pageData.trafficData.day) %>,
		xkey: "_id",
		ykeys: ["pageViews", "authViews", "uniqueUsers"],
		labels: ["Page Views", "Authenticated", "Unique Visitors"],
		dateFormat: formatHour,
		xLabelFormat: formatHour,
		parseTime: true,
		resize: true,
		hideHover: 'auto',
		smooth: true,
		pointSize: 4
	  });
	  <% } %>
	});
	</script>
</body>
</html>
