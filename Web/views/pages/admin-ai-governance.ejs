<!DOCTYPE html>
<html lang="en">
<head>
	<title><%= serverData.name %> AI Governance - Skynet Admin Console</title>
	<%- include('../partials/head') %>
	<script src="/static/js/form-change-listener.js"></script>
</head>
<body onload="SkynetUtil.SFS();">
	<%- include('../partials/dashboard-header') %>
	<%- include('../partials/dashboard-socket-updates') %>
	<section class="section is-white">
		<div class="container">
			<div class="columns">
				<div id="menu" class="column is-one-quarter">
					<%- include('../partials/admin-menu') %>
				</div>
				<div class="column">
					<h1 class="title">
						<i class="fas fa-shield-alt"></i> AI Governance & Usage
					</h1>
					<article class="message is-info">
						<div class="message-body">
							Control AI usage limits, budgets, and access permissions for your server.
						</div>
					</article>

					<!-- Usage Statistics -->
					<div class="box">
						<h4 class="subtitle is-4">
							<i class="fas fa-chart-bar"></i> Current Usage
						</h4>
						<div class="columns">
							<div class="column has-text-centered">
								<p class="heading">Total Tokens</p>
								<p class="title is-4"><%= configData.ai.usage.tokens.total.toLocaleString() %></p>
							</div>
							<div class="column has-text-centered">
								<p class="heading">Prompt Tokens</p>
								<p class="title is-5"><%= configData.ai.usage.tokens.prompt.toLocaleString() %></p>
							</div>
							<div class="column has-text-centered">
								<p class="heading">Completion Tokens</p>
								<p class="title is-5"><%= configData.ai.usage.tokens.completion.toLocaleString() %></p>
							</div>
							<div class="column has-text-centered">
								<p class="heading">Estimated Cost</p>
								<p class="title is-4">$<%= configData.ai.usage.cost.usd.toFixed(4) %></p>
							</div>
						</div>
						<div class="columns">
							<div class="column has-text-centered">
								<p class="heading">Today's Tokens</p>
								<p class="title is-5"><%= configData.ai.usage.budget.tokensDayTotal.toLocaleString() %></p>
							</div>
							<div class="column has-text-centered">
								<p class="heading">Today's Cost</p>
								<p class="title is-5">$<%= configData.ai.usage.budget.costDayUsd.toFixed(4) %></p>
							</div>
						</div>
					</div>

					<form id="form" onsubmit="SkynetUtil.submitForm(); return false;">
						<!-- Budget Limits -->
						<h4 class="subtitle is-4">
							<i class="fas fa-wallet"></i> Budget Limits
						</h4>
						<article class="message is-warning">
							<div class="message-body">
								Set to 0 to disable limits. Users will be blocked when they reach their limit.
							</div>
						</article>

						<div class="columns">
							<div class="column">
								<div class="field">
									<label class="label">Per-User Daily Token Limit</label>
									<div class="control">
										<input name="budget-perUserDailyTokens" class="input is-primary" type="number" 
											value="<%= configData.ai.governance.budget.perUserDailyTokens %>" min="0">
									</div>
									<p class="help">Maximum tokens each user can use per day (0 = unlimited)</p>
								</div>
							</div>
						</div>

						<div class="columns">
							<div class="column">
								<div class="field">
									<label class="label">Server Budget Type</label>
									<div class="control">
										<div class="select is-primary">
											<select name="budget-perGuild-unit">
												<option value="tokens" <%= configData.ai.governance.budget.perGuild.unit === 'tokens' ? 'selected' : '' %>>Tokens</option>
												<option value="usd" <%= configData.ai.governance.budget.perGuild.unit === 'usd' ? 'selected' : '' %>>USD</option>
											</select>
										</div>
									</div>
								</div>
							</div>
							<div class="column">
								<div class="field">
									<label class="label">Daily Token Budget</label>
									<div class="control">
										<input name="budget-perGuild-dailyTokens" class="input is-primary" type="number" 
											value="<%= configData.ai.governance.budget.perGuild.dailyTokens %>" min="0">
									</div>
									<p class="help">Server-wide daily token limit</p>
								</div>
							</div>
							<div class="column">
								<div class="field">
									<label class="label">Daily USD Budget</label>
									<div class="control">
										<input name="budget-perGuild-dailyUsd" class="input is-primary" type="number" step="0.01"
											value="<%= configData.ai.governance.budget.perGuild.dailyUsd %>" min="0">
									</div>
									<p class="help">Server-wide daily cost limit</p>
								</div>
							</div>
						</div>

						<hr>

						<!-- Bypass Roles -->
						<h4 class="subtitle is-4">
							<i class="fas fa-user-shield"></i> Rate Limit Bypass
						</h4>
						<p class="mb-3">Select roles that can bypass rate limits and cooldowns:</p>
						<div class="columns is-multiline">
							<% pageData.roleData.forEach(role => { %>
								<div class="column is-one-quarter">
									<label class="checkbox">
										<input name="bypass-cooldownRoles-<%= role.id %>" type="checkbox"
											<%= configData.ai.governance.bypass.cooldownRoles.includes(role.id) ? 'checked' : '' %>>
										<span style="color: <%= role.color || '#99AAB5' %>"><%= role.name %></span>
									</label>
								</div>
							<% }); %>
						</div>

						<hr>

						<!-- Tool Access -->
						<h4 class="subtitle is-4">
							<i class="fas fa-tools"></i> Tool Access Control
						</h4>
						<p class="mb-3">Control which AI tools are available:</p>
						
						<table class="table is-fullwidth">
							<thead>
								<tr>
									<th>Tool</th>
									<th>Description</th>
									<th>Allow</th>
									<th>Deny</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td><code>websearch</code></td>
									<td>Search the web for current information</td>
									<td>
										<label class="checkbox">
											<input name="tools-allow-websearch" type="checkbox"
												<%= configData.ai.governance.tools.allow.includes('websearch') ? 'checked' : '' %>>
										</label>
									</td>
									<td>
										<label class="checkbox">
											<input name="tools-deny-websearch" type="checkbox"
												<%= configData.ai.governance.tools.deny.includes('websearch') ? 'checked' : '' %>>
										</label>
									</td>
								</tr>
							</tbody>
						</table>
						<p class="help">If neither is checked, the tool is enabled by default. Deny takes precedence over Allow.</p>

						<hr>

						<!-- Reset Usage -->
						<h4 class="subtitle is-4">
							<i class="fas fa-redo"></i> Reset Usage Statistics
						</h4>
						<div class="field">
							<label class="checkbox">
								<input name="reset-usage" type="checkbox">
								<span class="has-text-danger">Reset all usage statistics to zero</span>
							</label>
							<p class="help">This will clear all token counts, costs, and per-user/channel statistics.</p>
						</div>

						<br>
						<% var formButtonsUnsaved = false; %>
						<%- include('../partials/form-buttons') %>
						<%- include('../partials/form-buttons-bar') %>
					</form>
				</div>
			</div>
		</div>
	</section>

	<%- include('../partials/footer') %>
	<%- include('../partials/scroll-top-button') %>
</body>
</html>
