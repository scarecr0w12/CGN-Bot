<!DOCTYPE html>
<html lang="en">
<head>
	<title><%= serverData.name %> AI Vector Memory - Skynet Admin Console</title>
	<%- include('../partials/head') %>
	<script src="/static/js/form-change-listener.js"></script>
</head>
<body onload="SkynetUtil.SFS();">
	<%- include('../partials/dashboard-header') %>
	<%- include('../partials/dashboard-socket-updates') %>
	<section class="section is-white">
		<div class="container">
			<div class="columns">
				<div id="menu" class="column is-one-quarter">
					<%- include('../partials/admin-menu') %>
				</div>
				<div class="column">
					<h1 class="title">
						<i class="fas fa-database"></i> AI Vector Memory
					</h1>
					<article class="message is-info">
						<div class="message-body">
							<strong>Semantic Search with Qdrant</strong><br>
							Connect your own <a href="https://qdrant.tech/" target="_blank">Qdrant</a> vector database to enable long-term memory and semantic search for your AI assistant.
							The AI will automatically store conversations and retrieve relevant context from past discussions.
						</div>
					</article>

					<form id="form" onsubmit="SkynetUtil.submitForm(); return false;">
						<!-- Enable Toggle -->
						<div class="field">
							<label class="checkbox is-size-5">
								<input name="vectorMemory-enabled" type="checkbox" id="vectorMemory-enabled"
									<%= configData.ai.vectorMemory.enabled ? 'checked' : '' %> onchange="toggleVectorConfig()">
								<strong>Enable Vector Memory</strong>
							</label>
							<p class="help">When enabled, conversations are stored in Qdrant and relevant context is retrieved for each query.</p>
						</div>

						<hr>

						<!-- Connection Settings -->
						<div id="vector-config" style="<%= configData.ai.vectorMemory.enabled ? '' : 'opacity: 0.5; pointer-events: none;' %>">
							<h4 class="subtitle is-4">
								<i class="fas fa-plug"></i> Qdrant Connection
							</h4>

							<div class="columns">
								<div class="column is-two-thirds">
									<div class="field">
										<label class="label">Qdrant URL</label>
										<div class="control has-icons-left">
											<input name="vectorMemory-url" id="qdrant-url" class="input is-primary" type="text" 
												value="<%= configData.ai.vectorMemory.url %>" 
												placeholder="https://your-cluster.cloud.qdrant.io:6333">
											<span class="icon is-small is-left">
												<i class="fas fa-server"></i>
											</span>
										</div>
										<p class="help">
											Qdrant Cloud or self-hosted URL. Get a free cluster at 
											<a href="https://cloud.qdrant.io/" target="_blank">cloud.qdrant.io</a>
										</p>
									</div>
								</div>
								<div class="column">
									<div class="field">
										<label class="label">
											API Key
											<% if (configData.ai.vectorMemory.hasApiKey) { %>
												<span class="tag is-success is-light"><i class="fas fa-check"></i> Set</span>
											<% } %>
										</label>
										<div class="control has-icons-left">
											<input name="vectorMemory-apiKey" id="qdrant-apikey" class="input" type="password" 
												value="<%= configData.ai.vectorMemory.apiKey %>" 
												placeholder="Optional for local instances">
											<span class="icon is-small is-left">
												<i class="fas fa-key"></i>
											</span>
										</div>
										<p class="help">Required for Qdrant Cloud</p>
									</div>
								</div>
							</div>

							<div class="field">
								<button type="button" class="button is-info is-outlined" onclick="testQdrantConnection()">
									<span class="icon"><i class="fas fa-plug"></i></span>
									<span>Test Connection</span>
								</button>
								<span id="connection-status" class="ml-3"></span>
							</div>

							<hr>

							<!-- Embedding Settings -->
							<h4 class="subtitle is-4">
								<i class="fas fa-vector-square"></i> Embedding Configuration
							</h4>

							<div class="columns">
								<div class="column">
									<div class="field">
										<label class="label">Embedding Model</label>
										<div class="control">
											<div class="select is-primary">
												<select name="vectorMemory-embeddingModel" id="embedding-model" onchange="updateVectorSize()">
													<% pageData.embeddingModels.forEach(model => { %>
														<option value="<%= model.id %>" data-size="<%= model.size %>"
															<%= configData.ai.vectorMemory.embeddingModel === model.id ? 'selected' : '' %>>
															<%= model.name %>
														</option>
													<% }); %>
												</select>
											</div>
										</div>
										<p class="help">Uses your OpenAI API key from AI Settings</p>
									</div>
								</div>
								<div class="column">
									<div class="field">
										<label class="label">Vector Size</label>
										<div class="control">
											<input name="vectorMemory-vectorSize" id="vector-size" class="input" type="number" 
												value="<%= configData.ai.vectorMemory.vectorSize %>" readonly>
										</div>
										<p class="help">Dimensions (auto-set by model)</p>
									</div>
								</div>
							</div>

							<hr>

							<!-- Search Settings -->
							<h4 class="subtitle is-4">
								<i class="fas fa-search"></i> Search Settings
							</h4>

							<div class="columns">
								<div class="column">
									<div class="field">
										<label class="label">Search Limit</label>
										<div class="control">
											<input name="vectorMemory-searchLimit" class="input is-primary" type="number" 
												value="<%= configData.ai.vectorMemory.searchLimit %>" min="1" max="20">
										</div>
										<p class="help">Max memories to retrieve per query (1-20)</p>
									</div>
								</div>
								<div class="column">
									<div class="field">
										<label class="label">Score Threshold</label>
										<div class="control">
											<input name="vectorMemory-scoreThreshold" class="input is-primary" type="number" 
												value="<%= configData.ai.vectorMemory.scoreThreshold %>" min="0" max="1" step="0.05">
										</div>
										<p class="help">Minimum similarity score (0-1, higher = more relevant)</p>
									</div>
								</div>
								<div class="column">
									<div class="field">
										<label class="label">Retention (days)</label>
										<div class="control">
											<input name="vectorMemory-retentionDays" class="input is-primary" type="number" 
												value="<%= configData.ai.vectorMemory.retentionDays %>" min="0" max="365">
										</div>
										<p class="help">Auto-delete after N days (0 = never)</p>
									</div>
								</div>
							</div>

							<hr>

							<!-- Storage Options -->
							<h4 class="subtitle is-4">
								<i class="fas fa-save"></i> Storage Options
							</h4>

							<div class="columns">
								<div class="column">
									<div class="field">
										<label class="checkbox">
											<input name="vectorMemory-storeMessages" type="checkbox" 
												<%= configData.ai.vectorMemory.storeMessages ? 'checked' : '' %>>
											Store conversation messages
										</label>
										<p class="help">Save user/AI exchanges to memory</p>
									</div>
								</div>
								<div class="column">
									<div class="field">
										<label class="checkbox">
											<input name="vectorMemory-storeFacts" type="checkbox" 
												<%= configData.ai.vectorMemory.storeFacts ? 'checked' : '' %>>
											Store extracted facts
										</label>
										<p class="help">Save key information the AI extracts</p>
									</div>
								</div>
								<div class="column">
									<div class="field">
										<label class="checkbox">
											<input name="vectorMemory-injectContext" type="checkbox" 
												<%= configData.ai.vectorMemory.injectContext ? 'checked' : '' %>>
											Inject context into prompts
										</label>
										<p class="help">Add relevant memories to AI context</p>
									</div>
								</div>
							</div>

							<div class="field">
								<label class="label">Context Prefix</label>
								<div class="control">
									<input name="vectorMemory-contextPrefix" class="input" type="text" 
										value="<%= configData.ai.vectorMemory.contextPrefix %>" 
										maxlength="200" placeholder="Relevant context from memory:">
								</div>
								<p class="help">Text shown before injected memories in the AI prompt</p>
							</div>

							<hr>

							<!-- Statistics -->
							<h4 class="subtitle is-4">
								<i class="fas fa-chart-bar"></i> Memory Statistics
							</h4>

							<% if (configData.ai.stats) { %>
								<div class="columns">
									<div class="column">
										<div class="box has-text-centered">
											<p class="heading">Stored Memories</p>
											<p class="title"><%= configData.ai.stats.pointsCount || 0 %></p>
										</div>
									</div>
									<div class="column">
										<div class="box has-text-centered">
											<p class="heading">Vector Dimension</p>
											<p class="title"><%= configData.ai.stats.vectorSize || 'N/A' %></p>
										</div>
									</div>
									<div class="column">
										<div class="box has-text-centered">
											<p class="heading">Status</p>
											<p class="title">
												<% if (configData.ai.stats.status === 'green') { %>
													<span class="has-text-success"><i class="fas fa-check-circle"></i> Active</span>
												<% } else if (configData.ai.stats.status === 'not_created') { %>
													<span class="has-text-warning"><i class="fas fa-clock"></i> Pending</span>
												<% } else { %>
													<span class="has-text-info"><%= configData.ai.stats.status %></span>
												<% } %>
											</p>
										</div>
									</div>
								</div>
							<% } else { %>
								<article class="message is-warning">
									<div class="message-body">
										<i class="fas fa-info-circle"></i> Configure and save your Qdrant connection to see statistics.
									</div>
								</article>
							<% } %>

							<!-- Danger Zone -->
							<hr>
							<h4 class="subtitle is-4 has-text-danger">
								<i class="fas fa-exclamation-triangle"></i> Danger Zone
							</h4>

							<div class="notification is-danger is-light">
								<div class="columns is-vcentered">
									<div class="column">
										<strong>Clear All Vector Memory</strong>
										<p class="is-size-7">Permanently delete all stored memories for this server. This cannot be undone.</p>
									</div>
									<div class="column is-narrow">
										<button type="button" class="button is-danger is-outlined" onclick="confirmClearMemory()">
											<span class="icon"><i class="fas fa-trash"></i></span>
											<span>Clear Memory</span>
										</button>
									</div>
								</div>
							</div>
						</div>

						<br>
						<% var formButtonsUnsaved = false; %>
						<%- include('../partials/form-buttons') %>
						<%- include('../partials/form-buttons-bar') %>
					</form>
				</div>
			</div>
		</div>
	</section>

	<%- include('../partials/footer') %>
	<%- include('../partials/scroll-top-button') %>

	<script>
		function toggleVectorConfig() {
			const enabled = document.getElementById('vectorMemory-enabled').checked;
			const config = document.getElementById('vector-config');
			config.style.opacity = enabled ? '1' : '0.5';
			config.style.pointerEvents = enabled ? 'auto' : 'none';
		}

		function updateVectorSize() {
			const select = document.getElementById('embedding-model');
			const selectedOption = select.options[select.selectedIndex];
			const size = selectedOption.getAttribute('data-size');
			document.getElementById('vector-size').value = size;
		}

		async function testQdrantConnection() {
			const url = document.getElementById('qdrant-url').value;
			const apiKey = document.getElementById('qdrant-apikey').value;
			const statusEl = document.getElementById('connection-status');

			if (!url) {
				statusEl.innerHTML = '<span class="has-text-danger"><i class="fas fa-times"></i> Please enter a URL</span>';
				return;
			}

			statusEl.innerHTML = '<span class="has-text-info"><i class="fas fa-spinner fa-spin"></i> Testing...</span>';

			try {
				const response = await fetch(`/dashboard/<%= serverData.id %>/ai/test-qdrant`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ url, apiKey })
				});
				const result = await response.json();

				if (result.success) {
					statusEl.innerHTML = `<span class="has-text-success"><i class="fas fa-check"></i> ${result.message}</span>`;
				} else {
					statusEl.innerHTML = `<span class="has-text-danger"><i class="fas fa-times"></i> ${result.error}</span>`;
				}
			} catch (err) {
				statusEl.innerHTML = `<span class="has-text-danger"><i class="fas fa-times"></i> Connection failed: ${err.message}</span>`;
			}
		}

		function confirmClearMemory() {
			if (!confirm('Are you sure you want to delete ALL stored memories for this server? This action cannot be undone.')) {
				return;
			}

			fetch(`/dashboard/<%= serverData.id %>/ai/clear-vector-memory`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({})
			})
			.then(res => res.json())
			.then(result => {
				if (result.success) {
					SkynetUtil.notify('Vector memory cleared successfully', 'success');
					setTimeout(() => location.reload(), 1500);
				} else {
					SkynetUtil.notify(result.error || 'Failed to clear memory', 'danger');
				}
			})
			.catch(err => {
				SkynetUtil.notify('Error: ' + err.message, 'danger');
			});
		}
	</script>
</body>
</html>
