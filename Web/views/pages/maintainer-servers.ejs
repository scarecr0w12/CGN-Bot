<!DOCTYPE html>
<html lang="en">
<head>
	<title>Server Management - <%= serverData.name %> Maintainer Console</title>
	<%- include('../partials/head') %>
	<style>
		.server-card {
			display: flex;
			align-items: center;
			gap: 1rem;
			padding: 1rem;
			border: 1px solid #dbdbdb;
			border-radius: 8px;
			margin-bottom: 1rem;
		}
		.server-icon {
			width: 48px;
			height: 48px;
			border-radius: 50%;
		}
		.server-info {
			flex: 1;
		}
		.tier-badge {
			padding: 0.25rem 0.75rem;
			border-radius: 20px;
			font-size: 0.875rem;
			font-weight: bold;
		}
	</style>
</head>
<body>
	<%- include('../partials/dashboard-header') %>
	<%- include('../partials/dashboard-socket-updates') %>

	<section class="section is-white">
		<div class="container">
			<div class="columns">
				<div id="menu" class="column is-one-quarter">
					<%- include('../partials/maintainer-menu') %>
				</div>
				<div class="column">
					<h1 class="title">
						<span class="icon"><i class="fa fa-server"></i></span>
						Server Management
					</h1>
					<article class="message is-primary">
						<div class="message-body">
							<div class="content">
								<p>Search for servers by Discord Server ID or name to manage their membership tier and features. Premium subscriptions are per-server.</p>
							</div>
						</div>
					</article>

					<!-- Search Form -->
					<div class="box">
						<form id="search-form" method="get" action="<%= currentPage %>">
							<div class="field has-addons">
								<div class="control is-expanded">
									<input class="input" type="text" name="q" placeholder="Enter Discord Server ID or name" value="<%= pageData.query || '' %>">
								</div>
								<div class="control">
									<button class="button is-info" type="submit">
										<span class="icon"><i class="fa fa-search"></i></span>
										<span>Search</span>
									</button>
								</div>
							</div>
						</form>
					</div>

					<!-- Server Stats -->
					<div class="level mb-4">
						<div class="level-left">
							<div class="level-item">
								<p class="has-text-grey">
									<strong><%= pageData.totalServers.toLocaleString() %></strong> servers total
									<% if (pageData.query) { %> matching "<%= pageData.query %>"<% } %>
								</p>
							</div>
						</div>
						<div class="level-right">
							<div class="level-item">
								<p class="has-text-grey is-size-7">
									Page <%= pageData.currentPageNum %> of <%= pageData.numPages || 1 %>
								</p>
							</div>
						</div>
					</div>

					<% if (pageData.servers && pageData.servers.length > 0) { %>
					<!-- Server List -->
					<% pageData.servers.forEach(server => { %>
					<div class="server-card">
						<img src="<%= server.icon || '/static/img/discord-icon.png' %>" class="server-icon" alt="Server Icon">
						<div class="server-info">
							<p class="has-text-weight-bold"><%= server.name %></p>
							<p class="is-size-7 has-text-grey">ID: <%= server._id %> â€¢ <%= server.memberCount.toLocaleString() || 0 %> members</p>
						</div>
						<div>
							<% if (server.subscription && server.subscription.tier_id && server.subscription.tier_id !== 'free') { %>
							<span class="tier-badge" style="background-color: <%= (configData.tiers.find(t => t._id === server.subscription.tier_id) || {}).color || '#3273dc' %>20; color: <%= (configData.tiers.find(t => t._id === server.subscription.tier_id) || {}).color || '#3273dc' %>;">
								<%= (configData.tiers.find(t => t._id === server.subscription.tier_id) || {}).name || server.subscription.tier_id %>
							</span>
							<% } else { %>
							<span class="tag">Free</span>
							<% } %>
						</div>
						<button class="button is-small is-info edit-server-btn" 
						data-server-id="<%= server._id %>" 
						data-server-name="<%= server.name %>" 
						data-tier-id="<%= server.subscription?.tier_id || '' %>">
						<span class="icon"><i class="fa fa-edit"></i></span>
						<span>Edit</span>
					</button>
					</div>
					<% }); %>

					<!-- Pagination -->
					<% if (pageData.numPages > 1) { %>
					<nav class="pagination is-centered mt-5" role="navigation" aria-label="pagination">
						<% const queryParam = pageData.query ? `&q=${encodeURIComponent(pageData.query)}` : ''; %>
						<a class="pagination-previous" 
						   <% if (pageData.currentPageNum <= 1) { %>disabled<% } else { %>
						   href="<%= currentPage %>?page=<%= pageData.currentPageNum - 1 %><%= queryParam %>"<% } %>>
							Previous
						</a>
						<a class="pagination-next"
						   <% if (pageData.currentPageNum >= pageData.numPages) { %>disabled<% } else { %>
						   href="<%= currentPage %>?page=<%= pageData.currentPageNum + 1 %><%= queryParam %>"<% } %>>
							Next
						</a>
						<ul class="pagination-list">
							<% 
							const maxVisiblePages = 5;
							let startPage = Math.max(1, pageData.currentPageNum - Math.floor(maxVisiblePages / 2));
							let endPage = Math.min(pageData.numPages, startPage + maxVisiblePages - 1);
							if (endPage - startPage + 1 < maxVisiblePages) {
								startPage = Math.max(1, endPage - maxVisiblePages + 1);
							}
							%>
							<% if (startPage > 1) { %>
							<li><a class="pagination-link" href="<%= currentPage %>?page=1<%= queryParam %>">1</a></li>
							<% if (startPage > 2) { %><li><span class="pagination-ellipsis">&hellip;</span></li><% } %>
							<% } %>
							<% for (let i = startPage; i <= endPage; i++) { %>
							<li>
								<a class="pagination-link <%= i === pageData.currentPageNum ? 'is-current' : '' %>" 
								   href="<%= currentPage %>?page=<%= i %><%= queryParam %>"
								   <% if (i === pageData.currentPageNum) { %>aria-current="page"<% } %>>
									<%= i %>
								</a>
							</li>
							<% } %>
							<% if (endPage < pageData.numPages) { %>
							<% if (endPage < pageData.numPages - 1) { %><li><span class="pagination-ellipsis">&hellip;</span></li><% } %>
							<li><a class="pagination-link" href="<%= currentPage %>?page=<%= pageData.numPages %><%= queryParam %>"><%= pageData.numPages %></a></li>
							<% } %>
						</ul>
					</nav>
					<% } %>

					<% } else { %>
					<article class="message is-warning">
						<div class="message-body">
							<% if (pageData.query) { %>
							No servers found matching "<%= pageData.query %>"
							<% } else { %>
							No servers found in the bot's cache.
							<% } %>
						</div>
					</article>
					<% } %>

					<!-- Recent Subscriptions -->
					<% if (pageData.recentSubscriptions && pageData.recentSubscriptions.length > 0) { %>
					<hr>
					<h2 class="subtitle">Recent Subscription Changes</h2>
					<table class="table is-fullwidth is-striped">
						<thead>
							<tr>
								<th>Server</th>
								<th>Tier</th>
								<th>Source</th>
								<th>Started</th>
								<th>Expires</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody>
							<% pageData.recentSubscriptions.forEach(sub => { %>
							<tr>
								<td>
									<div class="is-flex is-align-items-center" style="gap: 0.5rem;">
										<img src="<%= sub.icon || '/static/img/discord-icon.png' %>" style="width: 24px; height: 24px; border-radius: 50%;" alt="">
										<div>
											<span class="has-text-weight-bold"><%= sub.name %></span>
											<br><span class="is-size-7 has-text-grey"><%= sub._id %></span>
										</div>
									</div>
								</td>
								<td>
									<span class="tier-badge" style="background-color: <%= (configData.tiers.find(t => t._id === sub.subscription?.tier_id) || {}).color || '#3273dc' %>20; color: <%= (configData.tiers.find(t => t._id === sub.subscription?.tier_id) || {}).color || '#3273dc' %>;">
										<%= (configData.tiers.find(t => t._id === sub.subscription?.tier_id) || {}).name || sub.subscription?.tier_id %>
									</span>
								</td>
								<td><%= sub.subscription?.source || 'N/A' %></td>
								<td><%= sub.subscription?.started_at ? new Date(sub.subscription.started_at).toLocaleDateString() : 'N/A' %></td>
								<td><%= sub.subscription?.expires_at ? new Date(sub.subscription.expires_at).toLocaleDateString() : 'Never' %></td>
								<td>
									<button class="button is-small is-info edit-server-btn" 
										data-server-id="<%= sub._id %>" 
										data-server-name="<%= sub.name %>" 
										data-tier-id="<%= sub.subscription?.tier_id || '' %>">
										Edit
									</button>
								</td>
							</tr>
							<% }); %>
						</tbody>
					</table>
					<% } %>
				</div>
			</div>
		</div>
	</section>

	<!-- Edit Modal -->
	<div class="modal" id="edit-modal">
		<div class="modal-background" id="modal-close-bg"></div>
		<div class="modal-card">
			<header class="modal-card-head">
				<p class="modal-card-title">Edit Server Tier</p>
				<button class="delete" aria-label="close" id="modal-close-btn"></button>
			</header>
			<form id="edit-form" method="post" action="<%= currentPage %>">
				<section class="modal-card-body">
					<input type="hidden" name="server_id" id="edit-server-id">
					
					<div class="field">
						<label class="label">Server</label>
						<div class="control">
							<input class="input" type="text" id="edit-server-name" readonly>
						</div>
					</div>

					<div class="field">
						<label class="label">Assign Tier</label>
						<div class="control">
							<div class="select is-fullwidth">
								<select name="tier_id" id="edit-tier">
									<option value="">-- Free (No Tier) --</option>
									<% configData.tiers.forEach(tier => { %>
									<option value="<%= tier._id %>"><%= tier.name %> (Level <%= tier.level %>)</option>
									<% }); %>
								</select>
							</div>
						</div>
					</div>

					<div class="field">
						<label class="label">Expiration</label>
						<div class="control">
							<input class="input" type="date" name="expires_at" id="edit-expires">
						</div>
						<p class="help">Leave empty for no expiration (lifetime)</p>
					</div>

					<div class="field">
						<label class="label">Reason</label>
						<div class="control">
							<input class="input" type="text" name="reason" placeholder="e.g., gifted, manual upgrade, support">
						</div>
					</div>

					<hr>

					<div class="field">
						<label class="label">Grant Individual Features</label>
						<div class="control">
							<div class="tags">
								<% configData.features.forEach(feature => { %>
								<label class="checkbox mr-3">
									<input type="checkbox" name="grant_features[]" value="<%= feature._id %>">
									<%= feature.name %>
								</label>
								<% }); %>
							</div>
						</div>
						<p class="help">Grant features independently of tier</p>
					</div>
				</section>
				<footer class="modal-card-foot">
					<button type="submit" class="button is-success">Save Changes</button>
					<button type="button" class="button" id="modal-cancel-btn">Cancel</button>
					<button type="button" class="button is-danger is-outlined" id="cancel-subscription-btn">Cancel Subscription</button>
				</footer>
			</form>
		</div>
	</div>

	<%- include('../partials/footer') %>
	<%- include('../partials/scroll-top-button') %>
	
	<script>
	(function() {
		const modal = document.getElementById('edit-modal');
		const modalCloseBg = document.getElementById('modal-close-bg');
		const modalCloseBtn = document.getElementById('modal-close-btn');
		const cancelBtn = document.getElementById('cancel-subscription-btn');

		function openEditModal(serverId, serverName, currentTier) {
			document.getElementById('edit-server-id').value = serverId;
			document.getElementById('edit-server-name').value = serverName + ' (' + serverId + ')';
			document.getElementById('edit-tier').value = currentTier || '';
			modal.classList.add('is-active');
		}

		function closeEditModal() {
			modal.classList.remove('is-active');
		}

		// Event delegation for edit buttons
		document.addEventListener('click', function(e) {
			if (e.target.closest('.edit-server-btn')) {
				const btn = e.target.closest('.edit-server-btn');
				const serverId = btn.dataset.serverId;
				const serverName = btn.dataset.serverName;
				const tierId = btn.dataset.tierId;
				openEditModal(serverId, serverName, tierId);
			}
		});

		// Modal close handlers
		if (modalCloseBg) modalCloseBg.addEventListener('click', closeEditModal);
		if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeEditModal);
		
		const modalCancelBtn = document.getElementById('modal-cancel-btn');
		if (modalCancelBtn) modalCancelBtn.addEventListener('click', closeEditModal);

		// Cancel subscription handler
		if (cancelBtn) {
			cancelBtn.addEventListener('click', async function() {
				const serverId = document.getElementById('edit-server-id').value;
				if (!confirm('Are you sure you want to cancel this server\'s subscription?')) return;

				try {
					const response = await fetch('<%= currentPage %>/cancel', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ server_id: serverId }),
					});

					if (response.ok) {
						location.reload();
					} else {
						alert('Failed to cancel subscription');
					}
				} catch (err) {
					alert('An error occurred');
				}
			});
		}
	})();
	</script>
</body>
</html>
