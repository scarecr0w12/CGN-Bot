<%
// Defensive variable initialization for error pages and edge cases
const _pageData = typeof pageData !== "undefined" ? pageData : {};
const _hostingURL = typeof hostingURL !== "undefined" ? hostingURL : "";
const _currentPath = typeof currentPath !== "undefined" ? currentPath : "";
const _isProduction = typeof isProduction !== "undefined" ? isProduction : false;
const _disableExternalScripts = typeof disableExternalScripts !== "undefined" ? disableExternalScripts : false;
const _injection = typeof injection !== "undefined" ? injection : { headScript: "", pageScript: "" };

// SEO Configuration - can be overridden per page via pageData.seo
const defaultSeo = {
	title: "Skynet - Free Discord Bot for Moderation, Fun & Server Management",
	description: "Skynet is a powerful, free Discord bot with advanced moderation tools, fun commands, AI chat, custom extensions, giveaways, leveling system, and an easy-to-use web dashboard. Add to your server today!",
	keywords: "Discord bot, Discord moderation bot, free Discord bot, Discord server management, Discord giveaway bot, Discord leveling bot, Discord AI bot, Discord music bot, Discord ticket system, Discord developer tools, Discord fun commands, Discord auto moderation, Discord custom commands, Discord extensions, best Discord bot, Skynet bot",
	type: "website",
	image: "/static/img/logo.png",
	siteName: "Skynet Discord Bot"
};

const seo = _pageData.seo ? { ...defaultSeo, ..._pageData.seo } : defaultSeo;
const currentUrl = _hostingURL ? _hostingURL.replace(/\/$/, "") + _currentPath : "";
const fullImageUrl = seo.image.startsWith("http") ? seo.image : (_hostingURL ? _hostingURL.replace(/\/$/, "") + seo.image : seo.image);
%>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="author" content="Scarecr0w12">

<!-- Primary Meta Tags -->
<meta name="title" content="<%= seo.title %>">
<meta name="description" content="<%= seo.description %>">
<meta name="keywords" content="<%= seo.keywords %>">
<meta name="robots" content="index, follow">
<meta name="language" content="English">
<meta name="revisit-after" content="3 days">

<!-- Canonical URL -->
<% if (currentUrl) { %><link rel="canonical" href="<%= currentUrl %>"><% } %>

<!-- DNS Prefetch & Preconnect for External Resources -->
<link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="dns-prefetch" href="https://maxcdn.bootstrapcdn.com">
<link rel="dns-prefetch" href="https://unpkg.com">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com">

<!-- Preload Critical Assets -->
<link rel="preload" href="/static/css/modern-ui.css" as="style">
<link rel="preload" href="/static/js/app-skynet-v1.min.js" as="script">
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="<%= seo.type %>">
<meta property="og:site_name" content="<%= seo.siteName %>">
<meta property="og:title" content="<%= seo.title %>">
<meta property="og:description" content="<%= seo.description %>">
<meta property="og:image" content="<%= fullImageUrl %>">
<meta property="og:image:alt" content="Skynet Discord Bot Logo">
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
<% if (currentUrl) { %><meta property="og:url" content="<%= currentUrl %>"><% } %>
<meta property="og:locale" content="en_US">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@Skynet">
<meta name="twitter:creator" content="@GG142_">
<meta name="twitter:title" content="<%= seo.title %>">
<meta name="twitter:description" content="<%= seo.description %>">
<meta name="twitter:image" content="<%= fullImageUrl %>">

<!-- Discord-specific meta tags -->
<meta name="theme-color" content="#1e3a8a">

<!-- Favicons -->
<link rel="shortcut icon" type="image/png" href="/static/img/logo.png">
<link rel="icon" type="image/png" sizes="32x32" href="/static/img/logo.png">
<link rel="icon" type="image/png" sizes="16x16" href="/static/img/logo.png">
<link rel="apple-touch-icon" sizes="180x180" href="/static/img/logo.png">

<!-- Structured Data - Organization -->
<script type="application/ld+json"<%= typeof nonce !== 'undefined' ? ' nonce="' + nonce + '"' : '' %>>
{
	"@context": "https://schema.org",
	"@type": "SoftwareApplication",
	"name": "Skynet",
	"applicationCategory": "UtilitiesApplication",
	"operatingSystem": "Web, Discord",
	"description": "<%= defaultSeo.description.replace(/"/g, '\\"') %>",
	"offers": {
		"@type": "Offer",
		"price": "0",
		"priceCurrency": "USD"
	},
	"aggregateRating": {
		"@type": "AggregateRating",
		"ratingValue": "5",
		"ratingCount": "<%= typeof pageData !== 'undefined' && pageData.rawServerCount ? pageData.rawServerCount : '100' %>"
	},
	"author": {
		"@type": "Person",
		"name": "Scarecr0w12",
		"url": "https://github.com/Scarecr0w12"
	},
	"url": "<%= typeof hostingURL !== 'undefined' ? hostingURL : '' %>",
	"image": "<%= fullImageUrl %>",
	"screenshot": "<%= typeof hostingURL !== 'undefined' ? hostingURL.replace(/\/$/, '') : '' %>/static/img/admin-console.png"
}
</script>

<% if (typeof pageData !== "undefined" && pageData.breadcrumbs) { %>
<!-- Structured Data - Breadcrumbs -->
<script type="application/ld+json"<%= typeof nonce !== 'undefined' ? ' nonce="' + nonce + '"' : '' %>>
{
	"@context": "https://schema.org",
	"@type": "BreadcrumbList",
	"itemListElement": [
		<%- pageData.breadcrumbs.map((bc, i) => JSON.stringify({
			"@type": "ListItem",
			"position": i + 1,
			"name": bc.name,
			"item": (typeof hostingURL !== "undefined" ? hostingURL.replace(/\/$/, "") : "") + bc.url
		})).join(",\n\t\t") %>
	]
}
</script>
<% } %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/turbolinks/5.0.3/turbolinks.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js" defer></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css">

<!-- Critical CSS (loaded immediately) -->
<link rel="stylesheet" href="/static/css/modern-ui.css">
<link rel="stylesheet" href="/static/css/bulma-7.css">

<!-- Non-Critical CSS (deferred) -->
<link rel="preload" href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet"></noscript>
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"></noscript>
<link rel="preload" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"></noscript>
<link href="/static/fonts/icon-discord.css" rel="stylesheet">
<link rel="stylesheet" href="/static/css/extensions.css">

<!-- Editor & Utility Scripts (defer until needed) -->
<link rel="preload" href="/static/css/simplemde.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/static/css/simplemde.min.css"></noscript>
<script src="/static/js/simplemde.min.js" defer></script>
<script src="/static/js/showdown.min.js" defer></script>
<script src="/static/js/FileSaver.min.js" defer></script>
<link rel="preload" href="/static/css/auto-complete.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/static/css/auto-complete.css"></noscript>
<script src="/static/js/AutoComplete.min.js" defer></script>

<!-- Core Scripts (keep synchronous for compatibility) -->
<script src="/static/js/jquery-2.2.0.min.js"></script>
<script src="/static/js/bulma.js"></script>

<!-- Chart/Terminal Scripts (defer) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js" defer></script>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css"></noscript>
<script src="/static/js/terminal.min.js" defer></script>

<!-- CodeMirror (defer) -->
<link rel="preload" href="/static/css/codemirror.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/static/css/codemirror.css"></noscript>
<link rel="preload" href="/static/css/codemirror-monokai.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/static/css/codemirror-monokai.css"></noscript>
<script src="/static/js/codemirror.min.js" defer></script>

<!-- Utility Scripts -->
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js" defer></script>
<script src="/socket.io/socket.io.js"></script>

<!-- Matomo Analytics -->
<% const _matomoUrl = typeof matomoUrl !== "undefined" ? matomoUrl : ""; const _matomoSiteId = typeof matomoSiteId !== "undefined" ? matomoSiteId : ""; %>
<% if (_isProduction && _matomoUrl && _matomoSiteId) { %>
<script<%= typeof nonce !== 'undefined' ? ' nonce="' + nonce + '"' : '' %>>
(function() {
  // Initialize Matomo tracking
  var _paq = window._paq = window._paq || [];
  
  // Track initial page view
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  _paq.push(['enableHeartBeatTimer']);
  
  // Set up the tracker
  (function() {
    var u="<%= _matomoUrl %>";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '<%= _matomoSiteId %>']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
  
  // Track Turbolinks page changes
  document.addEventListener('turbolinks:load', function() {
    if (typeof _paq !== 'undefined') {
      _paq.push(['setCustomUrl', window.location.href]);
      _paq.push(['setDocumentTitle', document.title]);
      _paq.push(['trackPageView']);
    }
  });
  
  // Track outbound links
  document.addEventListener('click', function(e) {
    var link = e.target.closest('a');
    if (link && link.hostname && link.hostname !== window.location.hostname) {
      if (typeof _paq !== 'undefined') {
        _paq.push(['trackLink', link.href, 'link']);
      }
    }
  }, true);
  
  // Track downloads
  document.addEventListener('click', function(e) {
    var link = e.target.closest('a');
    if (link && link.href) {
      var downloadExtensions = /\.(zip|pdf|txt|docx|xlsx|pptx|skypkg|json)$/i;
      if (downloadExtensions.test(link.pathname)) {
        if (typeof _paq !== 'undefined') {
          _paq.push(['trackLink', link.href, 'download']);
        }
      }
    }
  }, true);
  
  // Expose tracking helper for custom events
  window.trackMatomoEvent = function(category, action, name, value) {
    if (typeof _paq !== 'undefined') {
      _paq.push(['trackEvent', category, action, name, value]);
    }
  };
  
  // Track form submissions
  document.addEventListener('submit', function(e) {
    var form = e.target;
    if (form.id || form.className) {
      var formName = form.id || form.className.split(' ')[0];
      if (typeof _paq !== 'undefined') {
        _paq.push(['trackEvent', 'Form', 'Submit', formName]);
      }
    }
  }, true);
})();
</script>
<% } %>

<% if (_injection.headScript && _isProduction && !_disableExternalScripts) { %>
	<%- _injection.headScript %>
<% } %>

<% if (_injection.pageScript && _isProduction && !_disableExternalScripts) { %>
<script<%= typeof nonce !== 'undefined' ? ' nonce="' + nonce + '"' : '' %>>
	document.addEventListener("turbolinks:load", () => {
		<%- _injection.pageScript %>
	});
</script>
<% } %>

<% if (typeof officialMode !== "undefined" && officialMode) { %>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script<%= typeof nonce !== 'undefined' ? ' nonce="' + nonce + '"' : '' %>>
	    // Only initialize AdSense once (prevents Turbolinks re-initialization)
	    if (!window.adsenseInitialized) {
		    (adsbygoogle = window.adsbygoogle || []).push({
			    google_ad_client: "<%= adsense.ID %>",
			    enable_page_level_ads: true
		    });
		    window.adsenseInitialized = true;
	    }
    </script>
<% } %>

<!-- Service Worker for PWA & Caching -->
<% if (_isProduction && !_disableExternalScripts) { %>
<script src="/static/js/sw-register.js" defer></script>
<% } %>

<!-- Lazy Loading for Images -->
<script src="/static/js/lazy-load.js" defer></script>

<%- include("./head-build.ejs") %>
