<%
// Helper to determine if a path is active
const isActive = (path) => currentPage === path;
const basePath = '/dashboard/maintainer';

// Helper for menu item rendering
const menuItem = (path, label, icon = null) => {
	const fullPath = `${basePath}/${path}`;
	const active = isActive(fullPath);
	const iconHtml = icon ? `<span class="icon is-small"><i class="${icon}"></i></span> ` : '';
	return active 
		? `<a class="is-active" href="#">${iconHtml}${label}</a>`
		: `<a href="${fullPath}">${iconHtml}${label}</a>`;
};

// Define sections and check active state
const serversPaths = ['servers/server-list', 'servers/big-message'];
const globalPaths = ['global-options/blocklist', 'global-options/bot-user', 'global-options/homepage', 'global-options/wiki-contributors', 'global-options/donations', 'global-options/vote-sites', 'global-options/bot-lists'];
const membershipPaths = ['membership/features', 'membership/tiers', 'membership/oauth', 'membership/payments', 'membership/servers'];
const managementPaths = ['management/maintainers', 'management/shards', 'management/injection', 'management/version', 'management/eval', 'management/logs'];
const infraPaths = ['infrastructure/cloudflare'];

const isInSection = (paths) => paths.some(p => isActive(`${basePath}/${p}`));
%>
<aside class="menu">
	<!-- Overview & Feedback (always visible) -->
	<ul class="menu-list">
		<li>
			<%- menuItem('maintainer', 'Overview') %>
			<%- menuItem('feedback', 'Feedback', 'fa fa-comments') %>
		</li>
	</ul>

	<!-- Servers Section -->
	<div class="menu-section<%= isInSection(serversPaths) ? ' has-active' : '' %>" data-section="servers">
		<div class="menu-section-header" onclick="toggleMenuSection('servers')">
			<p class="menu-label">
				<span class="icon is-small"><i class="fa fa-server"></i></span>
				<span>Servers</span>
			</p>
			<span class="collapse-icon"><i class="fas fa-chevron-down"></i></span>
		</div>
		<div class="menu-section-content">
			<ul class="menu-list">
				<li>
					<%- menuItem('servers/server-list', 'Server List') %>
					<%- menuItem('servers/big-message', 'BigMessage') %>
				</li>
			</ul>
		</div>
	</div>

	<% if (accessPrivileges.includes("administration")) { %>
	<!-- Global Options Section -->
	<div class="menu-section<%= isInSection(globalPaths) ? ' has-active' : '' %>" data-section="global">
		<div class="menu-section-header" onclick="toggleMenuSection('global')">
			<p class="menu-label">
				<span class="icon is-small"><i class="fa fa-cogs"></i></span>
				<span>Global Options</span>
			</p>
			<span class="collapse-icon"><i class="fas fa-chevron-down"></i></span>
		</div>
		<div class="menu-section-content">
			<ul class="menu-list">
				<li>
					<%- menuItem('global-options/blocklist', 'Blocklist') %>
					<%- menuItem('global-options/bot-user', 'Bot User') %>
					<%- menuItem('global-options/homepage', 'Homepage') %>
					<%- menuItem('global-options/wiki-contributors', 'Wiki Contributors') %>
					<% if (isSudoMaintainer) { %>
					<%- menuItem('global-options/donations', 'Donations') %>
					<%- menuItem('global-options/vote-sites', 'Vote Sites') %>
					<%- menuItem('global-options/bot-lists', 'Bot List APIs') %>
					<% } %>
				</li>
			</ul>
		</div>
	</div>
	<% } %>

	<% if (isSudoMaintainer && accessPrivileges.includes("administration")) { %>
	<!-- Membership Section -->
	<div class="menu-section<%= isInSection(membershipPaths) ? ' has-active' : '' %>" data-section="membership">
		<div class="menu-section-header" onclick="toggleMenuSection('membership')">
			<p class="menu-label">
				<span class="icon is-small"><i class="fa fa-id-card"></i></span>
				<span>Membership</span>
			</p>
			<span class="collapse-icon"><i class="fas fa-chevron-down"></i></span>
		</div>
		<div class="menu-section-content">
			<ul class="menu-list">
				<li>
					<%- menuItem('membership/features', 'Features') %>
					<%- menuItem('membership/tiers', 'Tiers') %>
					<%- menuItem('membership/oauth', 'OAuth Providers') %>
					<%- menuItem('membership/payments', 'Payment Providers') %>
					<%- menuItem('membership/servers', 'Server Management') %>
				</li>
			</ul>
		</div>
	</div>
	<% } %>

	<% if (accessPrivileges.includes("management")) { %>
	<!-- Management Section -->
	<div class="menu-section<%= isInSection(managementPaths) ? ' has-active' : '' %>" data-section="management">
		<div class="menu-section-header" onclick="toggleMenuSection('management')">
			<p class="menu-label">
				<span class="icon is-small"><i class="fa fa-wrench"></i></span>
				<span>Management</span>
			</p>
			<span class="collapse-icon"><i class="fas fa-chevron-down"></i></span>
		</div>
		<div class="menu-section-content">
			<ul class="menu-list">
				<li>
					<%- menuItem('management/maintainers', 'Maintainers') %>
					<%- menuItem('management/shards', 'Shards') %>
					<%- menuItem('management/injection', 'Script Injection') %>
					<%- menuItem('management/version', 'Skynet Version') %>
					<% if (accessPrivileges.includes("eval")) { %>
					<%- menuItem('management/eval', 'Evaluate') %>
					<% } %>
					<%- menuItem('management/logs', 'Logs') %>
				</li>
			</ul>
		</div>
	</div>

	<!-- Infrastructure Section -->
	<div class="menu-section<%= isInSection(infraPaths) ? ' has-active' : '' %>" data-section="infra">
		<div class="menu-section-header" onclick="toggleMenuSection('infra')">
			<p class="menu-label">
				<span class="icon is-small"><i class="fa fa-cloud"></i></span>
				<span>Infrastructure</span>
			</p>
			<span class="collapse-icon"><i class="fas fa-chevron-down"></i></span>
		</div>
		<div class="menu-section-content">
			<ul class="menu-list">
				<li>
					<%- menuItem('infrastructure/cloudflare', 'Cloudflare') %>
				</li>
			</ul>
		</div>
	</div>
	<% } %>
</aside>

<script>
// Menu section collapse/expand functionality
function toggleMenuSection(sectionId) {
	const section = document.querySelector(`.menu-section[data-section="${sectionId}"]`);
	if (!section) return;
	
	section.classList.toggle('collapsed');
	saveMenuState();
}

function saveMenuState() {
	const sections = document.querySelectorAll('.menu-section');
	const state = {};
	sections.forEach(section => {
		const id = section.dataset.section;
		state[id] = section.classList.contains('collapsed');
	});
	localStorage.setItem('maintainerMenuState', JSON.stringify(state));
}

function loadMenuState() {
	const saved = localStorage.getItem('maintainerMenuState');
	if (!saved) {
		// Default: collapse sections without active items
		document.querySelectorAll('.menu-section:not(.has-active)').forEach(section => {
			section.classList.add('collapsed');
		});
		return;
	}
	
	try {
		const state = JSON.parse(saved);
		document.querySelectorAll('.menu-section').forEach(section => {
			const id = section.dataset.section;
			// Always expand section with active item, otherwise use saved state
			if (section.classList.contains('has-active')) {
				section.classList.remove('collapsed');
			} else if (state[id]) {
				section.classList.add('collapsed');
			}
		});
	} catch (e) {
		console.error('Failed to load menu state:', e);
	}
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', loadMenuState);
</script>
