<form
	id="form"
	data-is-gallery="<%= isGallery ? '1' : '0' %>"
	data-submit-url="<%- isGallery ? ('/extensions/builder' + (pageData.extensionData._id ? ('?extid=' + pageData.extensionData._id) : '')) : ('/dashboard/' + serverData.id + '/other/extensions') %>"
	onsubmit="SkynetUtil.saveExtensionFromForm(this); return false;">
	<div class="field">
		<label class="label">Name</label>
		<p class="control">
			<input id="builder-title" name="name" class="input is-primary" type="text" value="<%- pageData.extensionData.name %>" minlength="3" maxlength="100" required>
		</p>
		<span class="help">A simple title for the extension.</span>
	</div>
	<hr>
	<div class="field">
		<label class="label">Type</label>
		<p class="control">
			<span class="select is-primary">
				<select name="type" onchange="$('.builder-type-options').addClass('is-hidden');$('#builder-type-' + this.value + '-options').removeClass('is-hidden');">
					<option value="command" <%= pageData.versionData.type=="command" ? "selected" : "" %>>Command</option>
					<option value="slash" <%= pageData.versionData.type=="slash" ? "selected" : "" %>>Slash Command</option>
					<option value="keyword" <%= pageData.versionData.type=="keyword" ? "selected" : "" %>>Keyword</option>
                	<option value="timer" <%= pageData.versionData.type=="timer" ? "selected" : "" %>>Timer</option>
					<option value="event" <%= pageData.versionData.type==="event" ? "selected" : ""%>>Event</option>
				</select>
			</span>
			<span class="help">Command extensions behave like regular bot commands. Keyword extensions are activated by messages that contain one or more of the phrases you define below. Timer extensions are run periodically to fetch information and/or post updates.</span>
		</p>
	</div>
	<span id="builder-type-command-options" class="builder-type-options <%= (pageData.versionData.type === "command" || !pageData.versionData.type) ? '' : 'is-hidden' %>">
		<div class="field">
			<label class="label">Command key</label>
			<p class="control">
				<input name="key" class="input is-primary" type="text" value="<%- pageData.versionData.key %>" minlength="3" maxlength="25">
				<span class="help">This string will be used to call the command. No spaces.</span>
			</p>
		</div>
		<div class="field">
			<label class="label">Usage</label>
			<p class="control">
				<input name="usage_help" class="input is-primary" type="text" value="<%= pageData.versionData.usage_help %>" maxlength="150">
				<span class="help">Simple usage information, e.g. <code>&lt;param1&gt; &lt;param2&gt;</code>.</span>
			</p>
		</div>
		<div class="field">
		<label class="label">Extended help</label>
			<p class="control">
				<textarea name="extended_help" class="textarea is-primary" maxlength="1000"><%- pageData.versionData.extended_help %></textarea>
				<span class="help">Detailed information about the extension, shown within the <code>help</code> command.</span>
			</p>
		</div>
		<% if (!isGallery) { %>
		<div class="field">
		<label class="label">Channel(s)</label>
			<% serverData.channelData.forEach(channel => { %>
			<label class="checkbox">
				<input name="enabled_channel_ids-<%= channel.id %>" type="checkbox" <%= pageData.extensionConfigData.disabled_channel_ids ? (!pageData.extensionConfigData.disabled_channel_ids.includes(channel.id) ? "checked" : "") : "" %>>
				#<%= channel.name %>
			</label>
			<br>
			<% }); %>
			<span class="help">The extension will run only in these channels.</span>
		</div>
		<div class="field">
			<label class="label">Permissions</label>
			<p class="control">
				<span class="select is-primary">
					<select name="adminLevel">
						<option value="0" <%= pageData.extensionConfigData.admin_level === 0 ? "" : "selected" %>>@everyone</option>
						<option value="1" <%= pageData.extensionConfigData.admin_level === 1 ? "selected" : "" %>>Admin level &ge;1</option>
						<option value="2" <%= pageData.extensionConfigData.admin_level === 2 ? "selected" : "" %>>Admin level &ge;2</option>
						<option value="3" <%= pageData.extensionConfigData.admin_level === 3 ? "selected" : "" %>>Admin level 3</option>
					</select>
				</span>
				<span class="help">The extension will only respond to members that have the selected bot admin level (or higher).</span>
			</p>
		</div>
		<% } %>
	</span>
	<span id="builder-type-slash-options" class="builder-type-options <%= pageData.versionData.type === "slash" ? '' : 'is-hidden' %>">
		<div class="field">
			<label class="label">Slash command name</label>
			<p class="control">
				<input name="key" class="input is-primary" type="text" value="<%- pageData.versionData.key %>" minlength="1" maxlength="32">
				<span class="help">The slash command name. Lowercase, no spaces (Discord rules apply).</span>
			</p>
		</div>
		<div class="field">
			<label class="label">Slash command description</label>
			<p class="control">
				<input name="slash_description" class="input is-primary" type="text" value="<%- pageData.versionData.slash_description || '' %>" maxlength="100">
				<span class="help">Shown in Discord's command picker.</span>
			</p>
		</div>
		<div class="field">
			<label class="label">Slash options (JSON)</label>
			<p class="control">
				<textarea name="slash_options_json" class="textarea is-primary" rows="10" placeholder='[{"name":"query","description":"Search query","type":"string","required":true}]'><%- pageData.versionData.slash_options ? JSON.stringify(pageData.versionData.slash_options, null, 2) : "[]" %></textarea>
				<span class="help">An array of option objects. Supported types: string, integer, number, boolean, user, channel, role, mentionable, attachment.</span>
			</p>
		</div>
		<% if (!isGallery) { %>
		<div class="field">
			<label class="label">Permissions</label>
			<p class="control">
				<span class="select is-primary">
					<select name="adminLevel">
						<option value="0" <%= pageData.extensionConfigData.admin_level === 0 ? "" : "selected" %>>@everyone</option>
						<option value="1" <%= pageData.extensionConfigData.admin_level === 1 ? "selected" : "" %>>Admin level &ge;1</option>
						<option value="2" <%= pageData.extensionConfigData.admin_level === 2 ? "selected" : "" %>>Admin level &ge;2</option>
						<option value="3" <%= pageData.extensionConfigData.admin_level === 3 ? "selected" : "" %>>Admin level 3</option>
					</select>
				</span>
				<span class="help">The extension will only respond to members that have the selected bot admin level (or higher).</span>
			</p>
		</div>
		<% } %>
	</span>
	<span id="builder-type-keyword-options" class="builder-type-options <%= pageData.versionData.type === "keyword" ? '' : 'is-hidden' %>">
		<div class="field">
			<label class="label">Keywords</label>
			<p class="control">
				<input name="keywords" class="input is-primary" type="text" value="<%- pageData.versionData.keywords ? pageData.versionData.keywords.join(',') : '' %>">
				<span class="help">Comma-separated list of strings that a message must contain to activate the extension.</span>
			</p>
		</div>
		<div class="field">
			<label class="label">Case-sensitivity</label>
			<p class="control">
				<label class="checkbox">
				<input name="case_sensitive" type="checkbox" <%= pageData.versionData.case_sensitive ? "checked" : "" %>>
					Extension keyword matching is case-sensitive
				</label>
			</p>
		</div>
		<% if (!isGallery) { %>
		<div class="field">
		<label class="label">Channel(s)</label>
			<% serverData.channelData.forEach(channel => { %>
			<label class="checkbox">
				<input name="enabled_channel_ids-<%= channel.id %>" type="checkbox" <%= pageData.extensionConfigData.disabled_channel_ids ? (!pageData.extensionConfigData.disabled_channel_ids.includes(channel.id) ? "checked" : "") : "" %>>
				#<%= channel.name %>
			</label>
			<br>
			<% }); %>
			<span class="help">The extension will run only in these channels.</span>
		</div>
		<div class="field">
			<label class="label">Permissions</label>
			<p class="control">
				<span class="select is-primary">
					<select name="adminLevel">
						<option value="0" <%= pageData.extensionConfigData.admin_level === 0 ? "" : "selected" %>>@everyone</option>
						<option value="1" <%= pageData.extensionConfigData.admin_level === 1 ? "selected" : "" %>>Admin level &ge;1</option>
						<option value="2" <%= pageData.extensionConfigData.admin_level === 2 ? "selected" : "" %>>Admin level &ge;2</option>
						<option value="3" <%= pageData.extensionConfigData.admin_level === 3 ? "selected" : "" %>>Admin level 3</option>
					</select>
				</span>
				<span class="help">The extension will only respond to members that have the selected bot admin level (or higher).</span>
			</p>
		</div>
		<% } %>
	</span>
	<span id="builder-type-timer-options" class="builder-type-options <%= pageData.versionData.type === "timer" ? '' : 'is-hidden' %>">
		<div class="field">
			<label class="label">Interval</label>
			<p class="control">
				<input name="interval" class="input is-primary" type="number" value="<%- pageData.versionData.interval || 300000 %>" min="300000" max="86400000" required>
				<span class="help">Number of milliseconds between each run of the extension, with a minimum of 300000ms (5 minutes) and a maximum of 86400000ms (24 hours).</span>
			</p>
		</div>
	</span>
	<span id="builder-type-event-options" class="builder-type-options <%= pageData.versionData.type === "event" ? '' : 'is-hidden' %>">
		<div class="field">
			<label class="label">Event</label>
			<p class="control">
				<div class="select is-primary">
  					<select name="event">
						<% pageData.events.forEach(event => { %>
						<option value="<%= event %>" <%= pageData.versionData.event === event ? "selected" : "" %>><%= event %></option>
						<% }); %>
  					</select>
				</div>
				<span class="help">The event that will trigger this extension.</span>
			</p>
		</div>
	</span>
	<hr>
	<div class="field">
		<label class="label">
			<i class="fa fa-shield-alt"></i> Scopes
			<span class="tag is-info is-light ml-2">Permissions your extension needs</span>
		</label>
		<span class="help mb-3">Select the capabilities your extension requires. Only request what you need - fewer scopes means easier approval.</span>
		
		<%
		// Group scopes by category
		const scopeCategories = {
			messages: { label: 'Messages', icon: 'fa-comment-alt', description: 'Read and send messages' },
			members: { label: 'Members', icon: 'fa-users', description: 'Access member information' },
			roles: { label: 'Roles', icon: 'fa-user-tag', description: 'Manage server roles' },
			channels: { label: 'Channels', icon: 'fa-hashtag', description: 'Access channel settings' },
			guild: { label: 'Server', icon: 'fa-server', description: 'Server-wide settings' },
			moderation: { label: 'Moderation', icon: 'fa-gavel', description: 'Moderation actions' },
			economy: { label: 'Economy', icon: 'fa-coins', description: 'Points and ranks' },
			data: { label: 'Data & Config', icon: 'fa-database', description: 'Storage and configuration' },
			network: { label: 'Network', icon: 'fa-globe', description: 'External requests' },
			advanced: { label: 'Advanced', icon: 'fa-cog', description: 'Advanced features' },
		};
		
		// Group scopes
		const groupedScopes = {};
		Object.values(pageData.scopes).forEach(scope => {
			const cat = scope.category || 'advanced';
			if (!groupedScopes[cat]) groupedScopes[cat] = [];
			groupedScopes[cat].push(scope);
		});
		%>
		
		<div class="scopes-container">
			<% Object.entries(scopeCategories).forEach(([catKey, catInfo]) => { 
				if (groupedScopes[catKey] && groupedScopes[catKey].length > 0) { %>
			<div class="scope-category box mb-3" style="padding: 1rem;">
				<div class="scope-category-header mb-2" style="cursor: pointer;" onclick="$(this).parent().find('.scope-category-body').slideToggle(200); $(this).find('.toggle-icon').toggleClass('fa-chevron-down fa-chevron-up');">
					<span class="icon-text">
						<span class="icon has-text-primary"><i class="fa <%= catInfo.icon %>"></i></span>
						<strong><%= catInfo.label %></strong>
						<span class="tag is-light ml-2"><%= groupedScopes[catKey].length %></span>
						<span class="icon is-small ml-auto"><i class="fa fa-chevron-down toggle-icon"></i></span>
					</span>
					<p class="help mb-0"><%= catInfo.description %></p>
				</div>
				<div class="scope-category-body columns is-multiline" style="margin-top: 0.5rem;">
					<% groupedScopes[catKey].forEach(scope => { %>
					<div class="column is-half-tablet is-one-third-desktop">
						<label class="checkbox scope-item" style="display: flex; align-items: flex-start; padding: 0.5rem; border-radius: 4px; background: var(--bulma-scheme-main-bis, #f5f5f5);">
							<input name="scope_<%= scope.scope %>" type="checkbox" style="margin-right: 0.5rem; margin-top: 0.2rem;" <%= pageData.versionData.scopes ? (pageData.versionData.scopes.includes(scope.scope) ? "checked" : "") : "" %>>
							<span>
								<code class="has-text-weight-semibold"><%= scope.scope %></code>
								<br>
								<small class="has-text-grey"><%= scope.permissionDescription %></small>
							</span>
						</label>
					</div>
					<% }); %>
				</div>
			</div>
			<% } }); %>
		</div>
	</div>
	
	<div class="field">
		<label class="label">Timeout</label>
		<p class="control">
			<input name="timeout" class="input is-primary" type="number" value="<%- pageData.versionData.timeout || 5000 %>" min="100" max="10000" required>
			<span class="help">Maximum execution time in milliseconds (100-10000). Extensions exceeding this will be terminated.</span>
		</p>
	</div>
	
	<hr>
	
	<div class="field">
		<label class="label">
			<i class="fa fa-globe"></i> Network Capability
			<span class="tag is-warning is-light ml-2">External API Access</span>
		</label>
		<span class="help mb-3">Choose what level of external network access your extension needs. Higher levels require maintainer approval.</span>
		
		<div class="control">
			<% const networkCaps = pageData.networkCapabilities || {}; %>
			<% const currentNetworkCap = pageData.versionData.network_capability || 'none'; %>
			
			<div class="columns is-multiline">
				<% Object.values(networkCaps).forEach(cap => { %>
				<div class="column is-half-tablet is-one-quarter-desktop">
					<label class="radio network-cap-item box mb-0" style="display: block; padding: 1rem; cursor: pointer; <%= currentNetworkCap === cap.level ? 'border: 2px solid #3273dc;' : '' %>">
						<div class="level is-mobile mb-2">
							<div class="level-left">
								<input type="radio" name="network_capability" value="<%= cap.level %>" <%= currentNetworkCap === cap.level ? 'checked' : '' %>>
								<span class="icon ml-2"><i class="fa <%= cap.icon %>"></i></span>
							</div>
							<div class="level-right">
								<% if (cap.requiresApproval) { %>
								<span class="tag is-warning is-small">Requires Approval</span>
								<% } else { %>
								<span class="tag is-success is-small">Auto-Approved</span>
								<% } %>
							</div>
						</div>
						<p class="has-text-weight-semibold mb-1"><%= cap.name %></p>
						<p class="help mb-0"><%= cap.description %></p>
						<% if (cap.tierRequired > 0) { %>
						<p class="help has-text-info mb-0">Requires Tier <%= cap.tierRequired %>+ server</p>
						<% } %>
					</label>
				</div>
				<% }); %>
			</div>
		</div>
		
		<% if (pageData.versionData.network_capability && ['network', 'network_advanced'].includes(pageData.versionData.network_capability)) { %>
		<div class="notification is-info is-light mt-3">
			<p class="mb-2"><strong>Network Capability Status:</strong></p>
			<% if (pageData.versionData.network_approved) { %>
			<span class="tag is-success"><i class="fa fa-check mr-1"></i> Approved</span>
			<% } else { %>
			<span class="tag is-warning"><i class="fa fa-clock mr-1"></i> Pending Approval</span>
			<p class="help mt-1">A maintainer will review your extension before network access is enabled.</p>
			<% } %>
		</div>
		<% } %>
	</div>
	
	<hr>
	
	<div class="field">
		<label class="label">
			<i class="fa fa-code"></i> Code Editor
		</label>
		
		<!-- API Deprecation Notice -->
		<div class="notification is-warning is-light mb-3" style="border-left: 4px solid #ffdd57;">
			<p class="has-text-weight-semibold mb-2">
				<span class="icon"><i class="fa fa-exclamation-triangle"></i></span>
				API Changes (v1.8.0)
			</p>
			<p class="is-size-7 mb-2">
				<strong>Removed:</strong> <code>modules.rss</code> (security vulnerability)
			</p>
			<p class="is-size-7 mb-2">
				<strong>Use instead:</strong> <code>modules.fetch</code> + <code>modules.xmlparser</code> for RSS feeds
			</p>
			<details class="is-size-7">
				<summary style="cursor: pointer;" class="has-text-weight-semibold">View migration example</summary>
				<pre class="mt-2" style="background: #fff; padding: 0.5rem; border-radius: 4px; overflow-x: auto;">const fetch = require('fetch');
const xmlparser = require('xmlparser');

const response = await fetch('https://example.com/feed.xml');
const parsed = xmlparser(response);
const items = parsed.rss?.channel?.item || [];</pre>
			</details>
		</div>
		
		<div class="level is-mobile mb-2">
			<div class="level-left">
				<div class="level-item">
					<div class="buttons are-small">
						<label class="button is-primary is-outlined">
							<span class="icon is-small"><i class="fa fa-upload"></i></span>
							<span>Upload</span>
							<input id="builder-code-upload" type="file" accept=".js,.skyext,.txt" onchange="SkynetUtil.uploadCode(this.files);" style="display: none;">
						</label>
						<a class="button is-primary is-outlined" onclick="SkynetUtil.downloadCode();">
							<span class="icon is-small"><i class="fa fa-download"></i></span>
							<span>Download</span>
						</a>
						<a class="button is-info is-outlined" onclick="SkynetUtil.formatCode();" title="Format code (Ctrl+Shift+F)">
							<span class="icon is-small"><i class="fa fa-align-left"></i></span>
							<span>Format</span>
						</a>
					</div>
				</div>
			</div>
			<div class="level-right">
				<div class="level-item">
					<a class="button is-small is-link is-outlined" href="/wiki/Extensions#javascriptapi" target="_blank">
						<span class="icon is-small"><i class="fa fa-book"></i></span>
						<span>API Docs</span>
					</a>
				</div>
			</div>
		</div>
		<div class="code-editor-wrapper" style="border: 1px solid #dbdbdb; border-radius: 4px; overflow: hidden;">
			<textarea id="builder-code-box" name="code" style="resize:none"><%- pageData.extensionData.code %></textarea>
		</div>
		<div class="level is-mobile mt-2">
			<div class="level-left">
				<span class="help">
					<strong>Shortcuts:</strong> 
					<code>Ctrl+S</code> Save &bull; 
					<code>Ctrl+/</code> Comment &bull; 
					<code>Ctrl+D</code> Duplicate line &bull;
					<code>Ctrl+F</code> Find
				</span>
			</div>
			<div class="level-right">
				<span class="help" id="code-stats">Lines: 0 | Characters: 0</span>
			</div>
		</div>
	</div>
	<hr>
	<% if (isGallery && pageData.extensionData._id) { %>
	<div class="field">
		<label class="label">Premium Settings</label>
		<p class="control">
			<label class="checkbox">
				<input id="builder-premium-enabled" type="checkbox" <%= pageData.extensionData.premium && pageData.extensionData.premium.is_premium ? "checked" : "" %>>
				Mark as Premium Extension
			</label>
		</p>
	</div>
	<div class="field" style="max-width: 340px;">
		<label class="label">Price (points)</label>
		<p class="control">
			<input id="builder-premium-price" class="input is-primary" type="number" data-revenue-share="<%= (pageData.extensionData.premium && pageData.extensionData.premium.revenue_share) ? pageData.extensionData.premium.revenue_share : ((pageData.premiumMarketplace && pageData.premiumMarketplace.default_revenue_share) ? pageData.premiumMarketplace.default_revenue_share : 70) %>" min="<%= (pageData.premiumMarketplace && pageData.premiumMarketplace.min_price_points) ? pageData.premiumMarketplace.min_price_points : 0 %>" max="<%= (pageData.premiumMarketplace && pageData.premiumMarketplace.max_price_points) ? pageData.premiumMarketplace.max_price_points : 1000000 %>" value="<%= pageData.extensionData.premium && pageData.extensionData.premium.price_points ? pageData.extensionData.premium.price_points : '' %>" <%= pageData.extensionData.premium && pageData.extensionData.premium.is_premium ? '' : 'disabled' %>>
		</p>
		<p class="help" id="builder-premium-estimate">Estimated earnings: <span id="builder-premium-estimate-value">0</span> points</p>
		<% if (pageData.premiumMarketplace && pageData.premiumMarketplace.approval_required) { %>
		<p class="help">Premium extensions require maintainer approval</p>
		<% } %>
	</div>
	<div class="field">
		<p class="control">
			<button class="button is-info" onclick="SkynetUtil.savePremiumSettings('<%= pageData.extensionData._id %>'); return false;">Save Premium Settings</button>
		</p>
	</div>
	<hr>
	<% } %>
	<% if (isGallery) { %>
	<div class="field">
		<label class="label">
			<i class="fa fa-tags"></i> Tags
			<span class="tag is-info is-light ml-2">Categorize your extension</span>
		</label>
		<span class="help mb-3">Select up to 3 tags that best describe your extension.</span>
		<div class="control">
			<div class="columns is-multiline">
				<% (pageData.extensionTags || []).forEach(tag => { %>
				<div class="column is-half-mobile is-one-third-tablet is-one-quarter-desktop">
					<label class="checkbox box mb-0 p-2 is-flex is-align-items-center" style="cursor: pointer;">
						<input type="checkbox" name="tags" value="<%= tag %>" class="mr-2" <%= pageData.extensionData.tags && pageData.extensionData.tags.includes(tag) ? "checked" : "" %>>
						<span><%= tag %></span>
					</label>
				</div>
				<% }); %>
			</div>
		</div>
	</div>
	<hr>
	<% } %>
	<div class="field">
		<label class="label">Description</label>
		<p class="control">
			<textarea id="builder-publish-description" name="description" class="textarea is-primary" maxlength="2000" placeholder="Description of extension, in markdown" required><%= pageData.extensionData.description %></textarea>
		</p>
	</div>
	<% if (isGallery && pageData.extensionData._id && pageData.extensionData.state === "saved") { %>
		<a id="publish-<%= pageData.extensionData._id %>" class="button" onclick="SkynetUtil.publishExtension('<%= pageData.extensionData._id %>');">
			<span class="icon is-small">
				<i class="fa fa-share-alt"></i>
			</span>
			<span>Publish</span>
		</a>
		<br>
    <% } else if (isGallery && pageData.extensionData._id && pageData.extensionData.state !== "saved") { %>
    	<a class="button is-info" href="/extensions/<%= pageData.extensionData.state === "version_queue" ? "queue" : pageData.extensionData.state %>?id=<%= pageData.extensionData._id %>" target="_blank">
			<span class="icon is-small">
				<i class="fa fa-info"></i>
			</span>
			<span>View Listing</span>
		</a>
		<br>
    <% } %>
	<hr>
	<%- include('../partials/form-buttons', { formButtonsUnsaved: false }) %>
    <% if (isGallery && pageData.extensionData._id && pageData.extensionData.state === "gallery") { %>
    	<span class="help">Updating the extension will <strong>not</strong> remove the old version from the gallery. Your new version will be in the queue until it has been approved by a Skynet maintainer. Points will be preserved.</span>
    <% } %>
</form>
