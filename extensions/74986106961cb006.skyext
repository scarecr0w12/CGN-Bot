const message = require('message');
const command = require('command');
const extension = require('extension');
const utils = require('utils');
const embed = require('embed');

const args = command.suffix.trim().split(/s+/).filter(Boolean);
const sub = (args[0] || '').toLowerCase();

const key = 'emojiquiz_' + message.author.id;

const QUESTIONS = [
	{ emojis: 'ğŸŒ§ï¸ğŸ§”â˜‚ï¸', answers: ['rain man', 'rainman'] },
	{ emojis: 'ğŸ¦ğŸ‘‘', answers: ['lion king', 'the lion king'] },
	{ emojis: 'ğŸš¢ğŸ§ŠğŸ’”', answers: ['titanic'] },
	{ emojis: 'ğŸ•·ï¸ğŸ§‘', answers: ['spiderman', 'spider-man', 'spider man'] },
	{ emojis: 'ğŸ‘»ğŸ”«', answers: ['ghostbusters', 'ghost busters'] },
	{ emojis: 'ğŸ§ŠğŸ‘¸', answers: ['frozen'] },
];

if (sub === 'start' || !sub) {
	const q = utils.random.pick(QUESTIONS);
	extension.storage.write(key, q);
	message.reply({
		embeds: [embed.create({
			title: 'ğŸ˜€ Emoji Quiz',
			description: 'Guess the phrase:

' + utils.discord.bold(q.emojis) + '

Answer with: emojiquiz answer <your guess>',
			color: embed.colors.PURPLE,
		})],
	});
	return;
}

if (sub === 'answer') {
	const q = extension.storage.get(key);
	if (!q) {
		message.reply({
			embeds: [embed.create({
				title: 'ğŸ˜€ Emoji Quiz',
				description: 'No active question. Use: emojiquiz start',
				color: embed.colors.ERROR,
			})],
		});
		return;
	}

	const guess = args.slice(1).join(' ').trim().toLowerCase();
	if (!guess) {
		message.reply({
			embeds: [embed.create({
				title: 'ğŸ˜€ Emoji Quiz',
				description: 'Provide your guess. Example: emojiquiz answer lion king',
				color: embed.colors.ERROR,
			})],
		});
		return;
	}

	extension.storage.write(key, null);
	const correct = q.answers.includes(guess);
	message.reply({
		embeds: [embed.create({
			title: correct ? 'âœ… Correct!' : 'âŒ Wrong!',
			description: correct
			? 'Nice! That was: ' + utils.discord.bold(q.answers[0])
			: 'Correct answer: ' + utils.discord.bold(q.answers[0]),
			color: correct ? embed.colors.SUCCESS : embed.colors.ERROR,
		})],
	});
	return;
}

message.reply({
	embeds: [embed.create({
		title: 'ğŸ˜€ Emoji Quiz',
		description: 'Usage: emojiquiz start | emojiquiz answer <text>',
		color: embed.colors.DEFAULT,
	})],
});