const message = require('message');
const command = require('command');
const extension = require('extension');
const utils = require('utils');
const embed = require('embed');

const args = command.suffix.trim().split(/\s+/).filter(Boolean);
const sub = (args[0] || '').toLowerCase();

const key = 'quotequiz_' + message.author.id;

const QUESTIONS = [
  { quote: 'May the Force be with you.', choices: ['Star Wars', 'Harry Potter', 'Lord of the Rings', 'The Matrix'], answer: 'a' },
  { quote: "I'll be back.", choices: ['Rocky', 'The Terminator', 'Rambo', 'Die Hard'], answer: 'b' },
  { quote: 'Why so serious?', choices: ['The Dark Knight', 'Joker', 'Batman Begins', 'Spider-Man'], answer: 'a' },
  { quote: 'To infinity and beyond!', choices: ['Toy Story', 'Finding Nemo', 'Cars', 'Up'], answer: 'a' },
];

const letters = ['a','b','c','d'];
const formatChoices = (q) => {
  let out = '';
  for (let i = 0; i < q.choices.length; i++) {
    out += utils.discord.bold(letters[i].toUpperCase() + ':') + ' ' + q.choices[i] + '\n';
  }
  return out;
};

if (sub === 'start' || !sub) {
  const q = utils.random.pick(QUESTIONS);
  extension.storage.write(key, { q, startedAt: Date.now() });
  message.reply({
    embeds: [embed.create({
      title: 'ğŸ’¬ Quote Quiz',
      description: utils.discord.italic('"' + q.quote + '"') + '\n\n' + formatChoices(q) + '\nAnswer with: quotequiz answer <a|b|c|d>',
      color: embed.colors.BLUE,
    })],
  });
  return;
}

if (sub === 'answer') {
  const state = extension.storage.get(key);
  if (!state || !state.q) {
    message.reply({
      embeds: [embed.create({
        title: 'ğŸ’¬ Quote Quiz',
        description: 'No active question. Use: quotequiz start',
        color: embed.colors.ERROR,
      })],
    });
    return;
  }

  const guess = (args[1] || '').toLowerCase();
  if (!letters.includes(guess)) {
    message.reply({
      embeds: [embed.create({
        title: 'ğŸ’¬ Quote Quiz',
        description: 'Answer must be a, b, c, or d.',
        color: embed.colors.ERROR,
      })],
    });
    return;
  }

  const correct = state.q.answer;
  extension.storage.write(key, null);
  message.reply({
    embeds: [embed.create({
      title: guess === correct ? 'âœ… Correct!' : 'âŒ Wrong!',
      description: utils.discord.bold('Your answer:') + ' ' + guess.toUpperCase() + '\n' + utils.discord.bold('Correct:') + ' ' + correct.toUpperCase() + ' (' + state.q.choices[letters.indexOf(correct)] + ')',
      color: guess === correct ? embed.colors.SUCCESS : embed.colors.ERROR,
    })],
  });
  return;
}

message.reply({
  embeds: [embed.create({
    title: 'ğŸ’¬ Quote Quiz',
    description: 'Usage: quotequiz start | quotequiz answer <a|b|c|d>',
    color: embed.colors.DEFAULT,
  })],
});