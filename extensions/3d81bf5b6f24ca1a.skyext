const message = require('message');
const command = require('command');
const extension = require('extension');
const utils = require('utils');
const embed = require('embed');

const flags = [
	{ emoji: 'ğŸ‡ºğŸ‡¸', country: 'UNITED STATES', alt: ['USA', 'AMERICA'] },
	{ emoji: 'ğŸ‡¬ğŸ‡§', country: 'UNITED KINGDOM', alt: ['UK', 'BRITAIN', 'ENGLAND'] },
	{ emoji: 'ğŸ‡¯ğŸ‡µ', country: 'JAPAN', alt: [] },
	{ emoji: 'ğŸ‡«ğŸ‡·', country: 'FRANCE', alt: [] },
	{ emoji: 'ğŸ‡©ğŸ‡ª', country: 'GERMANY', alt: [] },
	{ emoji: 'ğŸ‡®ğŸ‡¹', country: 'ITALY', alt: [] },
	{ emoji: 'ğŸ‡ªğŸ‡¸', country: 'SPAIN', alt: [] },
	{ emoji: 'ğŸ‡§ğŸ‡·', country: 'BRAZIL', alt: [] },
	{ emoji: 'ğŸ‡¨ğŸ‡¦', country: 'CANADA', alt: [] },
	{ emoji: 'ğŸ‡¦ğŸ‡º', country: 'AUSTRALIA', alt: [] },
	{ emoji: 'ğŸ‡²ğŸ‡½', country: 'MEXICO', alt: [] },
	{ emoji: 'ğŸ‡°ğŸ‡·', country: 'SOUTH KOREA', alt: ['KOREA'] },
	{ emoji: 'ğŸ‡·ğŸ‡º', country: 'RUSSIA', alt: [] },
	{ emoji: 'ğŸ‡¨ğŸ‡³', country: 'CHINA', alt: [] },
	{ emoji: 'ğŸ‡®ğŸ‡³', country: 'INDIA', alt: [] },
	{ emoji: 'ğŸ‡¸ğŸ‡ª', country: 'SWEDEN', alt: [] },
	{ emoji: 'ğŸ‡³ğŸ‡´', country: 'NORWAY', alt: [] },
	{ emoji: 'ğŸ‡³ğŸ‡±', country: 'NETHERLANDS', alt: ['HOLLAND'] },
	{ emoji: 'ğŸ‡µğŸ‡±', country: 'POLAND', alt: [] },
	{ emoji: 'ğŸ‡¹ğŸ‡·', country: 'TURKEY', alt: [] },
];

const stateKey = 'flagquiz_' + message.author.id;
let game = extension.storage.get(stateKey);
const guess = command.suffix.trim().toUpperCase();

if (!game || guess === 'NEW') {
	const flag = utils.random.pick(flags);
	game = { flag, score: game?.score || 0, streak: 0 };
	extension.storage.write(stateKey, game);
	
	message.reply({
		embeds: [embed.create({
			title: 'ğŸ³ï¸ Flag Quiz',
			description: 'Which country is this flag?\n\n' + flag.emoji + ' ' + flag.emoji + ' ' + flag.emoji,
			color: embed.colors.BLUE,
			footer: { text: 'Score: ' + game.score + ' | Streak: ' + game.streak },
		})]
	});
	return;
}

if (guess === 'SKIP') {
	const answer = game.flag.country;
	game.streak = 0;
	const flag = utils.random.pick(flags);
	game.flag = flag;
	extension.storage.write(stateKey, game);
	
	message.reply('â­ï¸ Skipped! It was **' + answer + '**\n\nNext flag: ' + flag.emoji);
	return;
}

if (!guess) {
	message.reply(game.flag.emoji + ' ' + game.flag.emoji + ' ' + game.flag.emoji + '\nType: `flagquiz <country>`');
	return;
}

const correct = guess === game.flag.country || game.flag.alt.includes(guess);

if (correct) {
	game.score++;
	game.streak++;
	const bonus = game.streak >= 3 ? ' ğŸ”¥ ' + game.streak + ' streak!' : '';
	
	const flag = utils.random.pick(flags);
	game.flag = flag;
	extension.storage.write(stateKey, game);
	
	message.reply({
		embeds: [embed.create({
			title: 'âœ… Correct!' + bonus,
			description: 'Next flag:\n\n' + flag.emoji + ' ' + flag.emoji + ' ' + flag.emoji,
			color: embed.colors.SUCCESS,
			footer: { text: 'Score: ' + game.score + ' | Streak: ' + game.streak },
		})]
	});
} else {
	game.streak = 0;
	extension.storage.write(stateKey, game);
	message.reply('âŒ Wrong! Try again or `flagquiz skip`');
}